C     path:      %P%
C     revision:  $Revision$
C     created:   $Date$  
C     presently: %H%  %T%
*******************************************************************************
*                                                                             *
*                  Optical depths developed for the                           *
*                                                                             *
*                RAPID RADIATIVE TRANSFER MODEL (RRTM)                        *
*                                                                             *
*                                                                             *
*            ATMOSPHERIC AND ENVIRONMENTAL RESEARCH, INC.                     *
*                        840 MEMORIAL DRIVE                                   *
*                        CAMBRIDGE, MA 02139                                  *
*                                                                             *
*                                                                             *
*                           ELI J. MLAWER                                     *
*                         STEVEN J. TAUBMAN~                                  *
*                         SHEPARD A. CLOUGH                                   *
*                                                                             *
*                                                                             *
*                         ~currently at GFDL                                  *
*                                                                             *
*                                                                             *
*                                                                             *
*                       email:  mlawer@aer.com                                *
*                                                                             *
*        The authors wish to acknowledge the contributions of the             *
*        following people:  Patrick D. Brown, Michael J. Iacono,              *
*        Ronald E. Farren, Luke Chen, Robert Bergstrom.                       *
*                                                                             *
*******************************************************************************
*     TAUMOL                                                                  *
*                                                                             *
*     This file contains the subroutines TAUGBn (where n goes from            *
*     1 to 16).  TAUGBn calculates the optical depths and Planck fractions    *
*     per g-value and layer for band n.                                       *
*                                                                             *
*  Output:  optical depths (unitless)                                         *
*           fractions needed to compute Planck functions at every layer       *
*               and g-value                                                   *
*                                                                             *
*     COMMON /TAUGCOM/  TAUG(MXLAY,MG)                                        *
*     COMMON /PLANKG/   FRACS(MXLAY,MG)                                       *
*                                                                             *
*  Input                                                                      *
*                                                                             *
*     COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)                  *
*     COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),                    *
*    &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND                        *
*     COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),         *
*    &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)              *
*     COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            *
*    &                  FAC10(MXLAY),FAC11(MXLAY)                             *
*     COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)                        *
*     COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)       *
*                                                                             *
*     Description:                                                            *
*     NG(IBAND) - number of g-values in band IBAND                            *
*     NSPA(IBAND) - for the lower atmosphere, the number of reference         *
*                   atmospheres that are stored for band IBAND per            *
*                   pressure level and temperature.  Each of these            *
*                   atmospheres has different relative amounts of the         *
*                   key species for the band (i.e. different binary           *
*                   species parameters).                                      *
*     NSPB(IBAND) - same for upper atmosphere                                 *
*     PAVEL - layer pressures (mb)                                            *
*     TAVEL - layer temperatures (degrees K)                                  *
*     PZ - level pressures (mb)                                               *
*     TZ - level tmeperatures (degrees K)                                     *
*     LAYTROP - layer at which switch is made from one combination of         *
*               key species to another                                        *
*     COLH2O, COLCO2,COLO3 - column amounts of water vapor,carbon dioxide,    *
*                            and ozone, respectively (molecules/cm**2)        *
*     FACij(LAY) - for layer LAY, these are factors that are needed to        *
*                  compute the interpolation factors that multiply the        *
*                  appropriate reference k-values.  A value of 0 (1) for      *
*                  i,j indicates that the corresponding factor multiplies     *
*                  reference k-value for the lower (higher) of the two        *
*                  appropriate temperatures, and altitudes, respectively.     *
*     JP - the index of the lower (in altitude) of the two appropriate        *
*          reference pressure levels needed for interpolation                 *
*     JT, JT1 - the indices of the lower of the two appropriate reference     *
*               temperatures needed for interpolation (for pressure           *
*               levels JP and JP+1, respectively)                             *
*     SELFFAC - scale factor needed to water vapor self-continuum, equals     *
*               (water vapor density)/(atmospheric density at 296K and        *
*               1013 mb)                                                      *
*     SELFFRAC - factor needed for temperature interpolation of reference     *
*                water vapor self-continuum data                              *
*     INDSELF - index of the lower of the two appropriate reference           *
*               temperatures needed for the self-continuum interpolation      *
*                                                                             *
*  Data input                                                                 *
*     COMMON /Kn/ KA(NSPA(n),5,13,MG), KB(NSPB(n),5,13:59,MG), SELFREF(10,MG) *
*        (note:  n is the band number)                                        *
*                                                                             *
*     Description:                                                            *
*     KA - k-values for low reference atmospheres (no water vapor             *
*          self-continuum) (units: cm**2/molecule)                            *
*     KB - k-values for high reference atmospheres (all sources)              *
*          (units: cm**2/molecule)                                            *
*     SELFREF - k-values for water vapor self-continuum for reference         *
*               atmospheres (used below LAYTROP)                              *
*               (units: cm**2/molecule)                                       *
*                                                                             *
*     DIMENSION ABSA(65*NSPA(n),MG), ABSB(235*NSPB(n),MG)                     *
*     EQUIVALENCE (KA,ABSA),(KB,ABSB)                                         *
*                                                                             *
*******************************************************************************


      SUBROUTINE TAUGB1

C     Written by Eli J. Mlawer, Atmospheric & Environmental Research.

C     BAND 1:  10-250 cm-1 (low - H2O; high - H2O)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K1/       KA(5,13,MG), KB(5,13:59,MG) , SELFREF(10,MG)
      COMMON /HVERSN/    HVRRTM,HVRREG,HVRRTR,HVRATM,HVRSET,HVRTAU,
     *                   HVDUM1(4),HVRUTL,HVREXT
      COMMON /HVRSNB/    HVRKG(NBANDS)

      CHARACTER*8 HVRRTM,HVRREG,HVRRTR,HVRATM,HVRSET,HVRTAU,
     *            HVDUM1,HVRUTL,HVREXT
      CHARACTER*8 HVRKG

      DIMENSION ABSA(65,MG),ABSB(235,MG)
      DIMENSION FRACREFA(MG),FRACREFB(MG)

      DATA FRACREFA/
     &    0.08452097,0.17952873,0.16214369,0.13602182,
     &    0.12760490,0.10302561,0.08392423,0.06337652,
     &    0.04206551,0.00487497,0.00410743,0.00344421,
     &    0.00285731,0.00157327,0.00080648,0.00012406/
      DATA FRACREFB/
     &    0.15492001,0.17384727,0.15165100,0.12675308,
     &    0.10986247,0.09006091,0.07584465,0.05990077,
     &    0.04113461,0.00438638,0.00374754,0.00313924,
     &    0.00234381,0.00167167,0.00062744,0.00010889/

      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB

      HVRTAU = '$Revision$'

C     Compute the optical depth by interpolating in ln(pressure) and 
C     temperature.  Below LAYTROP, the water vapor self-continuum 
C     is interpolated (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(1) + 1
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(1) + 1
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(1)
            TAUG(LAY,IG) = COLH2O(LAY) *
     &          (FAC00(LAY) * ABSA(IND0,IG) +
     &           FAC10(LAY) * ABSA(IND0+1,IG) +
     &           FAC01(LAY) * ABSA(IND1,IG) + 
     &           FAC11(LAY) * ABSA(IND1+1,IG) +
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG))))
            FRACS(LAY,IG) = FRACREFA(IG)
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(1) + 1
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(1) + 1
         DO 3000 IG = 1, NG(1)
            TAUG(LAY,IG) = COLH2O(LAY) * 
     &          (FAC00(LAY) * ABSB(IND0,IG) +
     &           FAC10(LAY) * ABSB(IND0+1,IG) +
     &           FAC01(LAY) * ABSB(IND1,IG) + 
     &           FAC11(LAY) * ABSB(IND1+1,IG)) 
            FRACS(LAY,IG) = FRACREFB(IG)
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB2

C     BAND 2:  250-500 cm-1 (low - H2O; high - H2O)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /SPECIES/  COLDRY(MXLAY),WKL(35,MXLAY)
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K2/       KA(5,13,MG), KB(5,13:59,MG) , SELFREF(10,MG)

      DIMENSION ABSA(65,MG),ABSB(235,MG)
      DIMENSION FC00(MXLAY),FC01(MXLAY),FC10(MXLAY),FC11(MXLAY)
      DIMENSION FRACREFA(MG,13),FRACREFB(MG), REFPARAM(13)

C     These are the mixing ratios for H2O for a MLS atmosphere at the 
C     13 RRTM reference pressure levels:  1.8759999E-02, 1.2223309E-02, 
C     5.8908667E-03, 2.7675382E-03, 1.4065107E-03, 7.5969833E-04, 
C     3.8875898E-04, 1.6542293E-04, 3.7189537E-05, 7.4764857E-06, 
C     4.3081886E-06, 3.3319423E-06, 3.2039343E-06/        

C     The following are parameters related to the reference water vapor
C     mixing ratios by REFPARAM(I) = REFH2O(I) / (.002+REFH2O(I)).
C     These parameters are used for the Planck function interpolation.
      DATA REFPARAM/
     &  0.903661, 0.859386, 0.746542, 0.580496, 0.412889, 0.275283, 
     &  0.162745, 7.63929E-02, 1.82553E-02, 3.72432E-03, 
     &  2.14946E-03, 1.66320E-03, 1.59940E-03/    

C     The ith set of reference fractions are from the ith reference
C     pressure level.
      DATA FRACREFA/
     &    0.18068060,0.16803175,0.15140158,0.12221480,
     &    0.10240850,0.09330297,0.07518960,0.05611294,
     &    0.03781487,0.00387192,0.00321285,0.00244440,
     &    0.00179546,0.00107704,0.00038798,0.00005060,
     &    0.17927621,0.16731168,0.15129538,0.12328085,
     &    0.10243484,0.09354796,0.07538418,0.05633071,
     &    0.03810832,0.00398347,0.00320262,0.00250029,
     &    0.00178666,0.00111127,0.00039438,0.00005169,
     &    0.17762886,0.16638555,0.15115446,0.12470623,
     &    0.10253213,0.09383459,0.07560240,0.05646568,
     &    0.03844077,0.00409142,0.00322521,0.00254918,
     &    0.00179296,0.00113652,0.00040169,0.00005259,
     &    0.17566043,0.16539773,0.15092199,0.12571971,
     &    0.10340609,0.09426189,0.07559051,0.05678188,
     &    0.03881499,0.00414102,0.00328551,0.00258795,
     &    0.00181648,0.00115145,0.00040969,0.00005357,
     &    0.17335825,0.16442548,0.15070701,0.12667464,
     &    0.10452303,0.09450833,0.07599410,0.05706393,
     &    0.03910370,0.00417880,0.00335256,0.00261708,
     &    0.00185491,0.00116627,0.00041759,0.00005464,
     &    0.17082544,0.16321516,0.15044247,0.12797612,
     &    0.10574646,0.09470057,0.07647423,0.05738756,
     &    0.03935621,0.00423789,0.00342651,0.00264549,
     &    0.00190188,0.00118281,0.00042592,0.00005583,
     &    0.16809277,0.16193336,0.15013184,0.12937409,
     &    0.10720784,0.09485368,0.07692636,0.05771774,
     &    0.03966988,0.00427754,0.00349696,0.00268946,
     &    0.00193536,0.00120222,0.00043462,0.00005712,
     &    0.16517997,0.16059248,0.14984852,0.13079269,
     &    0.10865030,0.09492947,0.07759736,0.05812201,
     &    0.03997169,0.00432356,0.00355308,0.00274031,
     &    0.00197243,0.00122401,0.00044359,0.00005849,
     &    0.16209179,0.15912023,0.14938223,0.13198245,
     &    0.11077233,0.09487948,0.07831636,0.05863440,
     &    0.04028239,0.00436804,0.00360407,0.00279885,
     &    0.00200364,0.00124861,0.00045521,0.00005996,
     &    0.15962425,0.15789343,0.14898103,0.13275230,
     &    0.11253940,0.09503502,0.07884382,0.05908009,
     &    0.04053524,0.00439971,0.00364269,0.00284965,
     &    0.00202758,0.00127076,0.00046408,0.00006114,
     &    0.15926200,0.15770932,0.14891729,0.13283882,
     &    0.11276010,0.09507311,0.07892222,0.05919230,
     &    0.04054824,0.00440833,0.00365575,0.00286459,
     &    0.00203786,0.00128405,0.00046504,0.00006146,
     &    0.15926351,0.15770483,0.14891177,0.13279966,
     &    0.11268171,0.09515216,0.07890341,0.05924807,
     &    0.04052851,0.00440870,0.00365425,0.00286878,
     &    0.00205747,0.00128916,0.00046589,0.00006221,
     &    0.15937765,0.15775780,0.14892603,0.13273248,
     &    0.11252731,0.09521657,0.07885858,0.05927679,
     &    0.04050184,0.00440285,0.00365748,0.00286791,
     &    0.00207507,0.00129193,0.00046679,0.00006308/
C     From P = 0.432 mb.
      DATA FRACREFB/
     &    0.17444289,0.16467269,0.15021490,0.12460902,
     &    0.10400643,0.09481928,0.07590704,0.05752856,
     &    0.03931715,0.00428572,0.00349352,0.00278938,
     &    0.00203448,0.00130037,0.00051560,0.00006255/
      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB

C     Compute the optical depth by interpolating in ln(pressure) and 
C     temperature.  Below LAYTROP, the water vapor self-continuum is 
C     interpolated (in temperature) separately.
      DO 2500 LAY = 1, LAYTROP
         WATER = 1.E20 * COLH2O(LAY) / COLDRY(LAY)
         H2OPARAM = WATER/(WATER +.002)
         DO 1800 IFRAC = 2, 12
            IF (H2OPARAM .GE. REFPARAM(IFRAC)) GO TO 1900
 1800    CONTINUE
 1900    CONTINUE
         FRACINT = (H2OPARAM-REFPARAM(IFRAC))/
     &        (REFPARAM(IFRAC-1)-REFPARAM(IFRAC))

         FP = FAC11(LAY) + FAC01(LAY)
         RTFP = SQRT(FP)
         CORR1 = RTFP/FP
         CORR2 = (1.-RTFP)/(1.-FP)
         FC00(LAY) = FAC00(LAY) * CORR2
         FC10(LAY) = FAC10(LAY) * CORR2
         FC01(LAY) = FAC01(LAY) * CORR1
         FC11(LAY) = FAC11(LAY) * CORR1
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(2) + 1
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(2) + 1
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(2)
            TAUG(LAY,IG) = COLH2O(LAY) * 
     &          (FC00(LAY) * ABSA(IND0,IG) +
     &           FC10(LAY) * ABSA(IND0+1,IG) +
     &           FC01(LAY) * ABSA(IND1,IG) + 
     &           FC11(LAY) * ABSA(IND1+1,IG) + 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG))))
            FRACS(LAY,IG) = FRACREFA(IG,IFRAC) + FRACINT * 
     &           (FRACREFA(IG,IFRAC-1)-FRACREFA(IG,IFRAC))
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         FP = FAC11(LAY) + FAC01(LAY)
         RTFP = SQRT(FP)
         CORR1 = RTFP/FP
         CORR2 = (1.-RTFP)/(1.-FP)
         FC00(LAY) = FAC00(LAY) * CORR2
         FC10(LAY) = FAC10(LAY) * CORR2
         FC01(LAY) = FAC01(LAY) * CORR1
         FC11(LAY) = FAC11(LAY) * CORR1
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(2) + 1
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(2) + 1
         DO 3000 IG = 1, NG(2)
            TAUG(LAY,IG) = COLH2O(LAY) * 
     &          (FC00(LAY) * ABSB(IND0,IG) +
     &           FC10(LAY) * ABSB(IND0+1,IG) +
     &           FC01(LAY) * ABSB(IND1,IG) + 
     &           FC11(LAY) * ABSB(IND1+1,IG))  
            FRACS(LAY,IG) = FRACREFB(IG)
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB3

C     BAND 3:  500-630 cm-1 (low - H2O,CO2; high - H2O,CO2)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PRECISE/  ONEMINUS
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K3/       KA(7,5,13,MG), KB(3,5,13:59,MG) , SELFREF(10,MG)

      DIMENSION SPARM31(7,13),SPARM32(3,13:59)
      DIMENSION ABSA(455,MG),ABSB(705,MG)
      DIMENSION FRACREF(MG,59)

      DATA SPARM31 / 
     &0.0,.92399E+0,.96050E+0,.97331E+0,.97985E+0,.98381E+0,.98648E+0,
     &0.0,.90909E+0,.95238E+0,.96774E+0,.97561E+0,.98039E+0,.98361E+0,
     &0.0,.86888E+0,.92984E+0,.95211E+0,.96364E+0,.97070E+0,.97547E+0,
     &0.0,.80014E+0,.88898E+0,.92314E+0,.94122E+0,.95242E+0,.96003E+0,
     &0.0,.70018E+0,.82365E+0,.87509E+0,.90330E+0,.92111E+0,.93339E+0,
     &0.0,.55649E+0,.71505E+0,.79010E+0,.83386E+0,.86252E+0,.88274E+0,
     &0.0,.39084E+0,.56202E+0,.65810E+0,.71961E+0,.76236E+0,.79380E+0,
     &0.0,.24065E+0,.38794E+0,.48737E+0,.55901E+0,.61309E+0,.65535E+0,
     &0.0,.12898E+0,.22849E+0,.30760E+0,.37199E+0,.42542E+0,.47048E+0,
     &0.0,.54244E-1,.10291E+0,.14681E+0,.18661E+0,.22286E+0,.25603E+0,
     &0.0,.34384E-1,.66482E-1,.96514E-1,.12467E+0,.15113E+0,.17604E+0,
     &0.0,.87717E-2,.17391E-1,.25861E-1,.34187E-1,.42372E-1,.50419E-1,
     &0.0,.63879E-2,.12695E-1,.18922E-1,.25071E-1,.31144E-1,.37141E-1/

      DATA SPARM32 / 
     &0.0,.63879E-02,.12695E-01,0.0,.63045E-02,.12530E-01,
     &0.0,.64838E-02,.12884E-01,0.0,.68209E-02,.13549E-01,
     &0.0,.72289E-02,.14354E-01,0.0,.77942E-02,.15468E-01,
     &0.0,.82561E-02,.16377E-01,0.0,.85705E-02,.16995E-01,
     &0.0,.88346E-02,.17514E-01,0.0,.91022E-02,.18040E-01,
     &0.0,.93599E-02,.18546E-01,0.0,.95285E-02,.18877E-01,
     &0.0,.96769E-02,.19168E-01,0.0,.97877E-02,.19386E-01,
     &0.0,.98681E-02,.19543E-01,0.0,.99259E-02,.19657E-01,
     &0.0,.10037E-01,.19874E-01,0.0,.10182E-01,.20159E-01,
     &0.0,.10425E-01,.20635E-01,0.0,.10635E-01,.21046E-01,
     &0.0,.10819E-01,.21407E-01,0.0,.10882E-01,.21531E-01,
     &0.0,.10916E-01,.21596E-01,0.0,.10916E-01,.21596E-01,
     &0.0,.10825E-01,.21417E-01,0.0,.10729E-01,.21229E-01,
     &0.0,.10633E-01,.21041E-01,0.0,.10431E-01,.20647E-01,
     &0.0,.10216E-01,.20225E-01,0.0,.10000E-01,.19802E-01,
     &0.0,.96906E-02,.19195E-01,0.0,.93386E-02,.18504E-01,
     &0.0,.89865E-02,.17813E-01,0.0,.86255E-02,.17104E-01,
     &0.0,.82470E-02,.16359E-01,0.0,.78683E-02,.15614E-01,
     &0.0,.74892E-02,.14867E-01,0.0,.71169E-02,.14133E-01,
     &0.0,.67474E-02,.13404E-01,0.0,.63778E-02,.12675E-01,
     &0.0,.60078E-02,.11944E-01,0.0,.56437E-02,.11224E-01,
     &0.0,.52816E-02,.10508E-01,0.0,.49184E-02,.97886E-02,
     &0.0,.45540E-02,.90667E-02,0.0,.41951E-02,.83551E-02,
     &0.0,.39044E-02,.77785E-02/

      DATA (FRACREF(I, 1), I = 1, 16)/
     &    0.15328856,0.14958146,0.14234376,0.13157937,
     &    0.11799214,0.10161859,0.08304608,0.06251600,
     &    0.04240444,0.00461630,0.00381180,0.00300120,
     &    0.00219762,0.00140321,0.00052723,0.00007353/
      DATA (FRACREF(I, 2), I = 1, 16)/
     &    0.15305430,0.14953595,0.14223608,0.13155766,
     &    0.11805224,0.10170144,0.08313692,0.06257791,
     &    0.04245924,0.00462593,0.00382254,0.00301664,
     &    0.00221047,0.00140830,0.00052986,0.00007457/
      DATA (FRACREF(I, 3), I = 1, 16)/
     &    0.15324405,0.14931691,0.14222193,0.13165608,
     &    0.11794753,0.10173426,0.08306202,0.06258915,
     &    0.04248203,0.00463004,0.00383612,0.00303052,
     &    0.00222508,0.00141611,0.00053353,0.00007534/
      DATA (FRACREF(I, 4), I = 1, 16)/
     &    0.15373114,0.14965543,0.14208126,0.13161798,
     &    0.11803754,0.10148730,0.08288162,0.06233580,
     &    0.04242409,0.00461032,0.00381661,0.00304159,
     &    0.00223980,0.00142600,0.00053812,0.00007585/
      DATA (FRACREF(I, 5), I = 1, 16)/
     &    0.15408941,0.15046850,0.14236887,0.13159113,
     &    0.11776390,0.10126867,0.08255013,0.06203458,
     &    0.04214407,0.00461198,0.00381547,0.00300414,
     &    0.00223314,0.00143693,0.00054299,0.00007636/
      DATA (FRACREF(I, 6), I = 1, 16)/
     &    0.15454446,0.15104184,0.14352180,0.13172056,
     &    0.11724035,0.10102683,0.08189029,0.06162917,
     &    0.04175412,0.00458389,0.00380206,0.00299861,
     &    0.00219781,0.00142334,0.00054848,0.00007692/
      DATA (FRACREF(I, 7), I = 1, 16)/
     &    0.15509981,0.15189463,0.14456651,0.13213535,
     &    0.11681513,0.10045318,0.08121415,0.06105305,
     &    0.04136025,0.00449944,0.00375356,0.00298084,
     &    0.00217907,0.00136836,0.00054923,0.00007752/
      DATA (FRACREF(I, 8), I = 1, 16)/
     &    0.15584894,0.15323608,0.14540623,0.13315043,
     &    0.11666571,0.09919667,0.08046706,0.06012134,
     &    0.04085679,0.00441868,0.00366222,0.00290575,
     &    0.00213837,0.00135115,0.00050308,0.00007143/
      DATA (FRACREF(I, 9), I = 1, 16)/
     &    0.15750284,0.15448701,0.14665364,0.13357858,
     &    0.11688663,0.09778926,0.07932252,0.05900840,
     &    0.04009897,0.00433776,0.00357811,0.00282098,
     &    0.00206167,0.00131082,0.00049401,0.00006952/
      DATA (FRACREF(I,10), I = 1, 16)/
     &    0.15944555,0.15596776,0.14677458,0.13384908,
     &    0.11673756,0.09668940,0.07843884,0.05818595,
     &    0.03945814,0.00425847,0.00352183,0.00278177,
     &    0.00203524,0.00129808,0.00048920,0.00006884/
      DATA (FRACREF(I,11), I = 1, 16)/
     &    0.16042542,0.15643005,0.14644969,0.13363920,
     &    0.11651807,0.09655064,0.07820591,0.05803800,
     &    0.03930718,0.00425340,0.00351800,0.00277818,
     &    0.00203359,0.00129598,0.00048850,0.00006874/
      DATA (FRACREF(I,12), I = 1, 16)/
     &    0.16070703,0.15653506,0.14636035,0.13349350,
     &    0.11641866,0.09656452,0.07811487,0.05806476,
     &    0.03930186,0.00425538,0.00351848,0.00277921,
     &    0.00203522,0.00129491,0.00048850,0.00006874/
      DATA (FRACREF(I,13), I = 1, 16)/
     &    0.16070351,0.15650947,0.14635348,0.13342644,
     &    0.11629947,0.09665169,0.07812268,0.05813536,
     &    0.03934858,0.00425822,0.00352062,0.00278134,
     &    0.00203790,0.00129474,0.00048874,0.00006877/
      DATA (FRACREF(I,14), I = 1, 16)/
     &    0.16058128,0.15631649,0.14630704,0.13334179,
     &    0.11619910,0.09683414,0.07824012,0.05826412,
     &    0.03943621,0.00426784,0.00352760,0.00278608,
     &    0.00204234,0.00129771,0.00048962,0.00006890/
      DATA (FRACREF(I,15), I = 1, 16)/
     &    0.16034926,0.15607437,0.14623122,0.13325553,
     &    0.11616360,0.09703977,0.07839298,0.05840832,
     &    0.03956426,0.00428238,0.00353667,0.00279311,
     &    0.00204769,0.00130160,0.00049050,0.00006906/
      DATA (FRACREF(I,16), I = 1, 16)/
     &    0.16006532,0.15584074,0.14615376,0.13318887,
     &    0.11613376,0.09724770,0.07854184,0.05857873,
     &    0.03968187,0.00430006,0.00354740,0.00280083,
     &    0.00205285,0.00130580,0.00049147,0.00006923/
      DATA (FRACREF(I,17), I = 1, 16)/
     &    0.15976913,0.15562136,0.14608295,0.13313201,
     &    0.11613017,0.09742074,0.07869107,0.05875119,
     &    0.03979378,0.00431067,0.00356000,0.00280782,
     &    0.00205805,0.00130948,0.00049257,0.00006939/
      DATA (FRACREF(I,18), I = 1, 16)/
     &    0.15948904,0.15541963,0.14597936,0.13309678,
     &    0.11614680,0.09756835,0.07884280,0.05891141,
     &    0.03989974,0.00431789,0.00357373,0.00281558,
     &    0.00206293,0.00131307,0.00049382,0.00006955/
      DATA (FRACREF(I,19), I = 1, 16)/
     &    0.15924549,0.15520692,0.14584287,0.13307941,
     &    0.11618902,0.09769462,0.07898761,0.05907148,
     &    0.03999790,0.00433023,0.00358135,0.00282518,
     &    0.00206810,0.00131625,0.00049520,0.00006971/
      DATA (FRACREF(I,20), I = 1, 16)/
     &    0.15899758,0.15497404,0.14569457,0.13306019,
     &    0.11622514,0.09784640,0.07914189,0.05923407,
     &    0.04009927,0.00434369,0.00358859,0.00283595,
     &    0.00207360,0.00131975,0.00049661,0.00006989/
      DATA (FRACREF(I,21), I = 1, 16)/
     &    0.15872630,0.15471151,0.14553817,0.13301232,
     &    0.11626522,0.09803783,0.07931238,0.05941037,
     &    0.04021101,0.00435831,0.00359987,0.00284495,
     &    0.00208066,0.00132374,0.00049820,0.00007008/
      DATA (FRACREF(I,22), I = 1, 16)/
     &    0.15840185,0.15439413,0.14535515,0.13292788,
     &    0.11634068,0.09827670,0.07951367,0.05961446,
     &    0.04034292,0.00437696,0.00361346,0.00285359,
     &    0.00209030,0.00132853,0.00050013,0.00007032/
      DATA (FRACREF(I,23), I = 1, 16)/
     &    0.15805051,0.15404372,0.14515403,0.13282280,
     &    0.11644399,0.09853682,0.07973259,0.05983155,
     &    0.04048815,0.00439687,0.00362833,0.00286408,
     &    0.00210073,0.00133382,0.00050226,0.00007058/
      DATA (FRACREF(I,24), I = 1, 16)/
     &    0.15770391,0.15369000,0.14494401,0.13272364,
     &    0.11655802,0.09878561,0.07996069,0.06004953,
     &    0.04062866,0.00441219,0.00364503,0.00287558,
     &    0.00210949,0.00133934,0.00050425,0.00007083/
      DATA (FRACREF(I,25), I = 1, 16)/
     &    0.15733512,0.15332702,0.14472482,0.13263559,
     &    0.11665463,0.09905130,0.08021420,0.06026515,
     &    0.04077382,0.00442856,0.00366137,0.00288795,
     &    0.00211864,0.00134481,0.00050638,0.00007110/
      DATA (FRACREF(I,26), I = 1, 16)/
     &    0.15695651,0.15296185,0.14450583,0.13255116,
     &    0.11674683,0.09932478,0.08047574,0.06047386,
     &    0.04092310,0.00444543,0.00367619,0.00290079,
     &    0.00212754,0.00135078,0.00050854,0.00007139/
      DATA (FRACREF(I,27), I = 1, 16)/
     &    0.15656880,0.15259579,0.14428939,0.13246951,
     &    0.11683677,0.09960536,0.08074293,0.06067310,
     &    0.04107716,0.00446274,0.00368890,0.00291410,
     &    0.00213600,0.00135748,0.00051071,0.00007168/
      DATA (FRACREF(I,28), I = 1, 16)/
     &    0.15617865,0.15223923,0.14408097,0.13240066,
     &    0.11693405,0.09986571,0.08100421,0.06087259,
     &    0.04122355,0.00447915,0.00370201,0.00292711,
     &    0.00214404,0.00136352,0.00051291,0.00007198/
      DATA (FRACREF(I,29), I = 1, 16)/
     &    0.15578710,0.15188333,0.14387541,0.13233423,
     &    0.11704522,0.10011023,0.08126742,0.06107243,
     &    0.04136509,0.00449580,0.00371629,0.00293834,
     &    0.00215272,0.00136930,0.00051497,0.00007227/
      DATA (FRACREF(I,30), I = 1, 16)/
     &    0.15539646,0.15152958,0.14367396,0.13227351,
     &    0.11716534,0.10034128,0.08152715,0.06127290,
     &    0.04150156,0.00451272,0.00373089,0.00294855,
     &    0.00216170,0.00137479,0.00051696,0.00007257/
      DATA (FRACREF(I,31), I = 1, 16)/
     &    0.15500934,0.15117966,0.14347799,0.13222183,
     &    0.11728940,0.10056166,0.08177736,0.06147411,
     &    0.04163278,0.00452988,0.00374489,0.00295857,
     &    0.00217057,0.00137998,0.00051895,0.00007286/
      DATA (FRACREF(I,32), I = 1, 16)/
     &    0.15462749,0.15083452,0.14328679,0.13217042,
     &    0.11742973,0.10077677,0.08201490,0.06166875,
     &    0.04176141,0.00454531,0.00375838,0.00296845,
     &    0.00217853,0.00138503,0.00052088,0.00007315/
      DATA (FRACREF(I,33), I = 1, 16)/
     &    0.15426710,0.15051247,0.14311053,0.13213193,
     &    0.11756939,0.10096993,0.08223094,0.06184842,
     &    0.04188045,0.00455866,0.00377101,0.00297805,
     &    0.00218575,0.00138967,0.00052269,0.00007341/
      DATA (FRACREF(I,34), I = 1, 16)/
     &    0.15402456,0.15029736,0.14299336,0.13210838,
     &    0.11766446,0.10109386,0.08237423,0.06197087,
     &    0.04196025,0.00456770,0.00377958,0.00298479,
     &    0.00219063,0.00139283,0.00052391,0.00007359/
      DATA (FRACREF(I,35), I = 1, 16)/
     &    0.15393090,0.15021576,0.14294910,0.13209933,
     &    0.11770003,0.10113430,0.08242911,0.06202295,
     &    0.04199150,0.00457184,0.00378306,0.00298782,
     &    0.00219268,0.00139418,0.00052438,0.00007366/
      DATA (FRACREF(I,36), I = 1, 16)/
     &    0.15384081,0.15013729,0.14290655,0.13209058,
     &    0.11773401,0.10117277,0.08248191,0.06207353,
     &    0.04202166,0.00457585,0.00378644,0.00299077,
     &    0.00219468,0.00139548,0.00052483,0.00007373/
      DATA (FRACREF(I,37), I = 1, 16)/
     &    0.15400831,0.15028501,0.14298587,0.13210307,
     &    0.11765299,0.10106844,0.08238427,0.06201451,
     &    0.04197302,0.00457116,0.00378240,0.00298802,
     &    0.00219215,0.00139379,0.00052402,0.00007361/
      DATA (FRACREF(I,38), I = 1, 16)/
     &    0.15417580,0.15043271,0.14306518,0.13211554,
     &    0.11757196,0.10096412,0.08228663,0.06195550,
     &    0.04192439,0.00456646,0.00377837,0.00298526,
     &    0.00218962,0.00139209,0.00052320,0.00007348/
      DATA (FRACREF(I,39), I = 1, 16)/
     &    0.15434329,0.15058041,0.14314450,0.13212802,
     &    0.11749095,0.10085980,0.08218900,0.06189649,
     &    0.04187576,0.00456177,0.00377434,0.00298250,
     &    0.00218710,0.00139040,0.00052239,0.00007336/
      DATA (FRACREF(I,40), I = 1, 16)/
     &    0.15466538,0.15086830,0.14330114,0.13215815,
     &    0.11734039,0.10066068,0.08199833,0.06177226,
     &    0.04177898,0.00455149,0.00376597,0.00297648,
     &    0.00218217,0.00138702,0.00052076,0.00007312/
      DATA (FRACREF(I,41), I = 1, 16)/
     &    0.15502967,0.15119585,0.14348058,0.13219625,
     &    0.11716984,0.10043267,0.08178011,0.06162933,
     &    0.04166942,0.00453955,0.00375650,0.00296954,
     &    0.00217657,0.00138314,0.00051891,0.00007285/
      DATA (FRACREF(I,42), I = 1, 16)/
     &    0.15542626,0.15155448,0.14367911,0.13224331,
     &    0.11698478,0.10017950,0.08153859,0.06147077,
     &    0.04155050,0.00452621,0.00374618,0.00296191,
     &    0.00217044,0.00137884,0.00051690,0.00007255/
      DATA (FRACREF(I,43), I = 1, 16)/
     &    0.15590318,0.15198331,0.14391930,0.13230185,
     &    0.11677364,0.09987377,0.08124542,0.06127452,
     &    0.04140737,0.00450974,0.00373309,0.00295259,
     &    0.00216309,0.00137365,0.00051448,0.00007219/
      DATA (FRACREF(I,44), I = 1, 16)/
     &    0.15645704,0.15247913,0.14419915,0.13237850,
     &    0.11652946,0.09952660,0.08089290,0.06104201,
     &    0.04124050,0.00449012,0.00371883,0.00294134,
     &    0.00215475,0.00136757,0.00051168,0.00007178/
      DATA (FRACREF(I,45), I = 1, 16)/
     &    0.15703556,0.15299606,0.14449601,0.13244841,
     &    0.11630031,0.09914835,0.08052547,0.06079585,
     &    0.04106458,0.00447039,0.00370344,0.00292923,
     &    0.00214591,0.00136131,0.00050870,0.00007135/
      DATA (FRACREF(I,46), I = 1, 16)/
     &    0.15767266,0.15357594,0.14482747,0.13253593,
     &    0.11604649,0.09872807,0.08011205,0.06051711,
     &    0.04086858,0.00444832,0.00368509,0.00291604,
     &    0.00213614,0.00135430,0.00050532,0.00007087/
      DATA (FRACREF(I,47), I = 1, 16)/
     &    0.15840085,0.15425298,0.14522281,0.13264515,
     &    0.11576401,0.09824228,0.07962272,0.06018265,
     &    0.04063734,0.00442302,0.00366337,0.00290082,
     &    0.00212442,0.00134612,0.00050144,0.00007035/
      DATA (FRACREF(I,48), I = 1, 16)/
     &    0.15915884,0.15499191,0.14563580,0.13276920,
     &    0.11548103,0.09771540,0.07909875,0.05982143,
     &    0.04039096,0.00439550,0.00364129,0.00288460,
     &    0.00211146,0.00133755,0.00049741,0.00006976/
      DATA (FRACREF(I,49), I = 1, 16)/
     &    0.15995651,0.15577751,0.14606231,0.13290516,
     &    0.11519374,0.09715571,0.07854374,0.05942977,
     &    0.04013624,0.00436734,0.00361491,0.00286848,
     &    0.00209898,0.00132776,0.00049318,0.00006915/
      DATA (FRACREF(I,50), I = 1, 16)/
     &    0.16076083,0.15656830,0.14649177,0.13304260,
     &    0.11490477,0.09659290,0.07798344,0.05903353,
     &    0.03988059,0.00433923,0.00358762,0.00285250,
     &    0.00208662,0.00131775,0.00048890,0.00006855/
      DATA (FRACREF(I,51), I = 1, 16)/
     &    0.16156515,0.15735909,0.14692123,0.13318007,
     &    0.11461580,0.09603009,0.07742315,0.05863729,
     &    0.03962494,0.00431112,0.00356033,0.00283651,
     &    0.00207427,0.00130773,0.00048462,0.00006796/
      DATA (FRACREF(I,52), I = 1, 16)/
     &    0.16236947,0.15814988,0.14735068,0.13331752,
     &    0.11432683,0.09546729,0.07686285,0.05824105,
     &    0.03936930,0.00428301,0.00353304,0.00282053,
     &    0.00206191,0.00129772,0.00048034,0.00006736/
      DATA (FRACREF(I,53), I = 1, 16)/
     &    0.16317379,0.15894067,0.14778014,0.13345498,
     &    0.11403786,0.09490449,0.07630256,0.05784482,
     &    0.03911365,0.00425490,0.00350575,0.00280454,
     &    0.00204955,0.00128770,0.00047606,0.00006676/
      DATA (FRACREF(I,54), I = 1, 16)/
     &    0.16397811,0.15973146,0.14820960,0.13359243,
     &    0.11374889,0.09434168,0.07574227,0.05744858,
     &    0.03885800,0.00422679,0.00347847,0.00278856,
     &    0.00203720,0.00127769,0.00047178,0.00006616/
      DATA (FRACREF(I,55), I = 1, 16)/
     &    0.16478243,0.16052225,0.14863905,0.13372988,
     &    0.11345991,0.09377888,0.07518197,0.05705234,
     &    0.03860235,0.00419869,0.00345118,0.00277257,
     &    0.00202484,0.00126767,0.00046750,0.00006556/
      DATA (FRACREF(I,56), I = 1, 16)/
     &    0.16558675,0.16131306,0.14906852,0.13386734,
     &    0.11317094,0.09321608,0.07462168,0.05665610,
     &    0.03834670,0.00417058,0.00342389,0.00275659,
     &    0.00201248,0.00125766,0.00046322,0.00006496/
      DATA (FRACREF(I,57), I = 1, 16)/
     &    0.16639107,0.16210385,0.14949797,0.13400479,
     &    0.11288197,0.09265327,0.07406138,0.05625986,
     &    0.03809105,0.00414247,0.00339660,0.00274060,
     &    0.00200013,0.00124764,0.00045894,0.00006437/
      DATA (FRACREF(I,58), I = 1, 16)/
     &    0.16719539,0.16289464,0.14992744,0.13414225,
     &    0.11259300,0.09209047,0.07350109,0.05586363,
     &    0.03783540,0.00411436,0.00336931,0.00272462,
     &    0.00198777,0.00123762,0.00045466,0.00006377/
      DATA (FRACREF(I,59), I = 1, 16)/
     &    0.16799970,0.16368543,0.15035689,0.13427970,
     &    0.11230403,0.09152766,0.07294080,0.05546739,
     &    0.03757975,0.00408625,0.00334203,0.00270863,
     &    0.00197541,0.00122761,0.00045038,0.00006317/
      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB
      STRRAT = 1.403829 

C     Compute the optical depth by interpolating in ln(pressure), 
C     temperature, and appropriate species.  Below LAYTROP, the water
C     vapor self-continuum is interpolated (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         SPECCOMB = COLH2O(LAY) + STRRAT*COLCO2(LAY)
         SPECPARM = COLH2O(LAY)/SPECCOMB
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         DO 2300 IREF = 2, 6
            IF(SPECPARM .LE. SPARM31(IREF,JP(LAY))) GO TO 2350
 2300    CONTINUE
 2350    CONTINUE
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(3) + IREF - 1
	 FS = (SPECPARM - SPARM31(IREF-1,JP(LAY))) /
     &        (SPARM31(IREF,JP(LAY)) - SPARM31(IREF-1,JP(LAY)))
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         JP1 = JP(LAY) + 1
         DO 2400 IREF = 2, 6
            IF(SPECPARM .LE. SPARM31(IREF,JP1)) GO TO 2450
 2400    CONTINUE
 2450    CONTINUE
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(3) + IREF - 1
	 FS1 = (SPECPARM - SPARM31(IREF-1,JP1)) /
     &        (SPARM31(IREF,JP1) - SPARM31(IREF-1,JP1))
         FAC001 = (1. - FS1) * FAC01(LAY)
         FAC011 = (1. - FS1) * FAC11(LAY)
         FAC101 = FS1 * FAC01(LAY)
         FAC111 = FS1 * FAC11(LAY)
         INDS = INDSELF(LAY)
         SPECMULT = 8. * SPECPARM
         INDPLNK = 1 + INT(SPECMULT)
         FRACPLNK = AMOD(SPECMULT,1.0)
C     Get rid of this when FRACREF is replaced with FRACREFA, B.
         FP = FAC11(LAY) + FAC01(LAY)
         JJP = JP1 - 1
         IF (FP .GE. 0.5) JJP = JP1
         DO 2000 IG = 1, NG(3)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSA(IND0,IG) +
     &           FAC100 * ABSA(IND0+1,IG) +
     &           FAC010 * ABSA(IND0+7,IG) +
     &           FAC110 * ABSA(IND0+8,IG) +
     &           FAC001 * ABSA(IND1,IG) + 
     &           FAC101 * ABSA(IND1+1,IG) +
     &           FAC011 * ABSA(IND1+7,IG) +
     &           FAC111 * ABSA(IND1+8,IG)) +
     &           COLH2O(LAY) * 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG)))
         FRACS(LAY,IG) = FRACREF(IG,JJP)
C         FRACS(LAY,IG) = FRACREFA(IG,INDPLNK) + FRACPLNK *
C     &           (FRACREFA(IG,INDPLNK+1) - FRACREFA(IG,INDPLNK))
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         SPECCOMB = COLH2O(LAY) + STRRAT*COLCO2(LAY)
         SPECPARM = COLH2O(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         IREF = 3
         IF(SPECPARM .LE. SPARM32(2,JP(LAY))) IREF = 2
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(3) + IREF - 1
	 FS = (SPECPARM - SPARM32(IREF-1,JP(LAY))) /
     &        (SPARM32(IREF,JP(LAY)) - SPARM32(IREF-1,JP(LAY)))
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         JP1 = JP(LAY) + 1
         IREF = 3
         IF(SPECPARM .LE. SPARM32(2,JP1)) IREF = 2
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(3) + IREF - 1
	 FS1 = (SPECPARM - SPARM32(IREF-1,JP1)) /
     &        (SPARM32(IREF,JP1) - SPARM32(IREF-1,JP1))
         FAC001 = (1. - FS1) * FAC01(LAY)
         FAC011 = (1. - FS1) * FAC11(LAY)
         FAC101 = FS1 * FAC01(LAY)
         FAC111 = FS1 * FAC11(LAY)
         SPECMULT = 4. * SPECPARM
         INDPLNK = 1 + INT(SPECMULT)
         FRACPLNK = AMOD(SPECMULT,1.0)
C     Get rid of this when FRACREF is replaced with FRACREFA, B.
         FP = FAC11(LAY) + FAC01(LAY)
         JJP = JP1 - 1
         IF (FP .GE. 0.5) JJP = JP1
         DO 3000 IG = 1, NG(3)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSB(IND0,IG) +
     &           FAC100 * ABSB(IND0+1,IG) +
     &           FAC010 * ABSB(IND0+3,IG) +
     &           FAC110 * ABSB(IND0+4,IG) +
     &           FAC001 * ABSB(IND1,IG) + 
     &           FAC101 * ABSB(IND1+1,IG) +
     &           FAC011 * ABSB(IND1+3,IG) +
     &           FAC111 * ABSB(IND1+4,IG))
         FRACS(LAY,IG) = FRACREF(IG,JJP)
C         FRACS(LAY,IG) = FRACREFB(IG,INDPLNK) + FRACPLNK *
C     &           (FRACREFB(IG,INDPLNK+1) - FRACREFB(IG,INDPLNK))
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB4

C     BAND 4:  630-700 cm-1 (low - H2O,CO2; high - O3,CO2)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PRECISE/  ONEMINUS
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K4/       KA(7,5,13,MG), KB(3,5,13:59,MG) , SELFREF(10,MG)

      DIMENSION SPARM41(7,13),SPARM42(3,13:59)
      DIMENSION ABSA(455,MG),ABSB(705,MG)
      REAL FRACREF(MG,59)

      DATA SPARM41 / 
     &0.0,.19305E-1,.37879E-1,.55762E-1,.72993E-1,.89606E-1,.10563E+0,
     &0.0,.15935E-1,.31371E-1,.46330E-1,.60833E-1,.74903E-1,.88557E-1,
     &0.0,.10616E-1,.21010E-1,.31187E-1,.41155E-1,.50919E-1,.60487E-1,
     &0.0,.64410E-2,.12800E-1,.19077E-1,.25276E-1,.31396E-1,.37440E-1,
     &0.0,.37673E-2,.75062E-2,.11217E-1,.14901E-1,.18557E-1,.22186E-1,
     &0.0,.20276E-2,.40470E-2,.60583E-2,.80614E-2,.10057E-1,.12044E-1,
     &0.0,.10379E-2,.20735E-2,.31071E-2,.41385E-2,.51678E-2,.61950E-2,
     &0.0,.51290E-3,.10253E-2,.15371E-2,.20485E-2,.25593E-2,.30695E-2,
     &0.0,.23973E-3,.47934E-3,.71884E-3,.95822E-3,.11975E-2,.14366E-2,
     &0.0,.92865E-4,.18571E-3,.27854E-3,.37136E-3,.46415E-3,.55693E-3,
     &0.0,.57656E-4,.11531E-3,.17295E-3,.23058E-3,.28821E-3,.34584E-3,
     &0.0,.14329E-4,.28658E-4,.42987E-4,.57315E-4,.71642E-4,.85969E-4,
     &0.0,.10410E-4,.20820E-4,.31230E-4,.41639E-4,.52049E-4,.62458E-4/

      DATA SPARM42 / 
     &0.0,.59487E-04,.11897E-03,0.0,.95597E-04,.19118E-03,
     &0.0,.15055E-03,.30105E-03,0.0,.19883E-03,.39759E-03,
     &0.0,.25272E-03,.50531E-03,0.0,.31265E-03,.62511E-03,
     &0.0,.39257E-03,.78483E-03,0.0,.45439E-03,.90836E-03,
     &0.0,.50928E-03,.10180E-02,0.0,.55619E-03,.11118E-02,
     &0.0,.60333E-03,.12059E-02,0.0,.65695E-03,.13130E-02,
     &0.0,.70526E-03,.14095E-02,0.0,.74371E-03,.14863E-02,
     &0.0,.75431E-03,.15075E-02,0.0,.74428E-03,.14874E-02,
     &0.0,.69132E-03,.13817E-02,0.0,.62614E-03,.12515E-02,
     &0.0,.53902E-03,.10775E-02,0.0,.45851E-03,.91659E-03,
     &0.0,.38299E-03,.76569E-03,0.0,.32801E-03,.65581E-03,
     &0.0,.28048E-03,.56081E-03,0.0,.24126E-03,.48240E-03,
     &0.0,.21282E-03,.42555E-03,0.0,.18496E-03,.36986E-03,
     &0.0,.15710E-03,.31416E-03,0.0,.14201E-03,.28398E-03,
     &0.0,.12863E-03,.25722E-03,0.0,.11524E-03,.23046E-03,
     &0.0,.10231E-03,.20460E-03,0.0,.89581E-04,.17915E-03,
     &0.0,.76851E-04,.15369E-03,0.0,.65244E-04,.13048E-03,
     &0.0,.55876E-04,.11175E-03,0.0,.46508E-04,.93011E-04,
     &0.0,.37140E-04,.74276E-04,0.0,.31127E-04,.62252E-04,
     &0.0,.26660E-04,.53318E-04,0.0,.22192E-04,.44384E-04,
     &0.0,.17725E-04,.35450E-04,0.0,.16376E-04,.32752E-04,
     &0.0,.16583E-04,.33166E-04,0.0,.16791E-04,.33582E-04,
     &0.0,.16999E-04,.33998E-04,0.0,.17752E-04,.35504E-04,
     &0.0,.24351E-04,.48700E-04/

      DATA (FRACREF(I, 1), I = 1, 16)/
     &    0.15369745,0.14925002,0.14185129,0.13150144,
     &    0.11799580,0.10182060,0.08315878,0.06260666,
     &    0.04239761,0.00462390,0.00382592,0.00302468,
     &    0.00221922,0.00141358,0.00053284,0.00007499/
      DATA (FRACREF(I, 2), I = 1, 16)/
     &    0.15398827,0.14917129,0.14178987,0.13147625,
     &    0.11801846,0.10175618,0.08316480,0.06255234,
     &    0.04237485,0.00462201,0.00382450,0.00302364,
     &    0.00221847,0.00141313,0.00053268,0.00007495/
      DATA (FRACREF(I, 3), I = 1, 16)/
     &    0.15425219,0.14914161,0.14171356,0.13146278,
     &    0.11802702,0.10170288,0.08315796,0.06250939,
     &    0.04233095,0.00461960,0.00382268,0.00302227,
     &    0.00221755,0.00141257,0.00053247,0.00007493/
      DATA (FRACREF(I, 4), I = 1, 16)/
     &    0.15442729,0.14916986,0.14169480,0.13146155,
     &    0.11800094,0.10165969,0.08312421,0.06247139,
     &    0.04230872,0.00460645,0.00382050,0.00302069,
     &    0.00221644,0.00141190,0.00053222,0.00007489/
      DATA (FRACREF(I, 5), I = 1, 16)/
     &    0.15465954,0.14904964,0.14172073,0.13152108,
     &    0.11795793,0.10161236,0.08310074,0.06243213,
     &    0.04229142,0.00458520,0.00381813,0.00301900,
     &    0.00221526,0.00141118,0.00053195,0.00007486/
      DATA (FRACREF(I, 6), I = 1, 16)/
     &    0.15486687,0.14906085,0.14160989,0.13154593,
     &    0.11800101,0.10154394,0.08307030,0.06239527,
     &    0.04227591,0.00456731,0.00381478,0.00301704,
     &    0.00221391,0.00141035,0.00053165,0.00007481/
      DATA (FRACREF(I, 7), I = 1, 16)/
     &    0.15506943,0.14908840,0.14146966,0.13148972,
     &    0.11811250,0.10153054,0.08301334,0.06236966,
     &    0.04225169,0.00456686,0.00379675,0.00301494,
     &    0.00221241,0.00140946,0.00053132,0.00007476/
      DATA (FRACREF(I, 8), I = 1, 16)/
     &    0.15530421,0.14915431,0.14128920,0.13143042,
     &    0.11817761,0.10154444,0.08294922,0.06234290,
     &    0.04221403,0.00458106,0.00377685,0.00301262,
     &    0.00221081,0.00140849,0.00053097,0.00007471/
      DATA (FRACREF(I, 9), I = 1, 16)/
     &    0.15557902,0.14914323,0.14122719,0.13134088,
     &    0.11808258,0.10163893,0.08288356,0.06234978,
     &    0.04217016,0.00459486,0.00376551,0.00300416,
     &    0.00220906,0.00140743,0.00053057,0.00007466/
      DATA (FRACREF(I,10), I = 1, 16)/
     &    0.15575600,0.14918917,0.14113449,0.13128600,
     &    0.11796061,0.10173580,0.08283917,0.06238133,
     &    0.04214054,0.00459027,0.00378064,0.00298730,
     &    0.00220762,0.00140656,0.00053023,0.00007461/
      DATA (FRACREF(I,11), I = 1, 16)/
     &    0.15572543,0.14924867,0.14105800,0.13126287,
     &    0.11791711,0.10172518,0.08294446,0.06238921,
     &    0.04214546,0.00459326,0.00379461,0.00297848,
     &    0.00220593,0.00140637,0.00053015,0.00007460/
      DATA (FRACREF(I,12), I = 1, 16)/
     &    0.15565750,0.14931135,0.14101441,0.13125917,
     &    0.11790522,0.10166266,0.08306557,0.06237885,
     &    0.04215862,0.00459127,0.00379962,0.00298575,
     &    0.00219899,0.00140628,0.00053009,0.00007459/
      DATA (FRACREF(I,13), I = 1, 16)/
     &    0.15557417,0.14932416,0.14103235,0.13124183,
     &    0.11793092,0.10159146,0.08313208,0.06241143,
     &    0.04217328,0.00458936,0.00379950,0.00299811,
     &    0.00219064,0.00140621,0.00053006,0.00007459/
      DATA (FRACREF(I,14), I = 1, 16)/
     &    0.15546466,0.14929630,0.14109354,0.13125317,
     &    0.11794295,0.10156933,0.08311503,0.06247494,
     &    0.04219699,0.00459140,0.00379959,0.00300354,
     &    0.00219136,0.00140345,0.00053010,0.00007460/
      DATA (FRACREF(I,15), I = 1, 16)/
     &    0.15533562,0.14929804,0.14113426,0.13130565,
     &    0.11789051,0.10160135,0.08307303,0.06252652,
     &    0.04223572,0.00459344,0.00380058,0.00300382,
     &    0.00219755,0.00139915,0.00053016,0.00007461/
      DATA (FRACREF(I,16), I = 1, 16)/
     &    0.15524921,0.14923906,0.14122708,0.13130596,
     &    0.11788347,0.10160252,0.08306625,0.06258182,
     &    0.04224197,0.00459280,0.00380183,0.00300467,
     &    0.00220321,0.00139609,0.00053022,0.00007461/
      DATA (FRACREF(I,17), I = 1, 16)/
     &    0.15521364,0.14917485,0.14126608,0.13128735,
     &    0.11791766,0.10159996,0.08307018,0.06260087,
     &    0.04226329,0.00459365,0.00380115,0.00300551,
     &    0.00220562,0.00139607,0.00053028,0.00007462/
      DATA (FRACREF(I,18), I = 1, 16)/
     &    0.15519723,0.14911269,0.14130417,0.13130371,
     &    0.11790935,0.10159183,0.08308650,0.06258038,
     &    0.04230234,0.00459738,0.00380129,0.00300592,
     &    0.00220591,0.00139761,0.00053014,0.00007463/
      DATA (FRACREF(I,19), I = 1, 16)/
     &    0.15516213,0.14909606,0.14138508,0.13127469,
     &    0.11786270,0.10160585,0.08309107,0.06256656,
     &    0.04233715,0.00460074,0.00380250,0.00300620,
     &    0.00220578,0.00140003,0.00052938,0.00007464/
      DATA (FRACREF(I,20), I = 1, 16)/
     &    0.15508656,0.14910220,0.14145452,0.13128699,
     &    0.11782137,0.10160232,0.08309259,0.06256549,
     &    0.04236313,0.00460249,0.00380577,0.00300604,
     &    0.00220595,0.00140200,0.00052864,0.00007465/
      DATA (FRACREF(I,21), I = 1, 16)/
     &    0.15499595,0.14907850,0.14153907,0.13132286,
     &    0.11780499,0.10157323,0.08310003,0.06257395,
     &    0.04237989,0.00460419,0.00380847,0.00300695,
     &    0.00220616,0.00140364,0.00052808,0.00007467/
      DATA (FRACREF(I,22), I = 1, 16)/
     &    0.15488830,0.14903572,0.14162938,0.13136743,
     &    0.11780098,0.10156360,0.08310292,0.06258167,
     &    0.04239069,0.00460627,0.00381043,0.00300879,
     &    0.00220648,0.00140521,0.00052779,0.00007469/
      DATA (FRACREF(I,23), I = 1, 16)/
     &    0.15477248,0.14899690,0.14168215,0.13143696,
     &    0.11781542,0.10156455,0.08310083,0.06258234,
     &    0.04240279,0.00460682,0.00381181,0.00301111,
     &    0.00220704,0.00140637,0.00052774,0.00007470/
      DATA (FRACREF(I,24), I = 1, 16)/
     &    0.15465523,0.14897043,0.14173239,0.13147846,
     &    0.11784650,0.10157346,0.08309436,0.06258198,
     &    0.04241841,0.00460614,0.00381210,0.00301368,
     &    0.00220745,0.00140679,0.00052820,0.00007472/
      DATA (FRACREF(I,25), I = 1, 16)/
     &    0.15452024,0.14896214,0.14177522,0.13151099,
     &    0.11787161,0.10160574,0.08309090,0.06257922,
     &    0.04242656,0.00461222,0.00381111,0.00301532,
     &    0.00220903,0.00140699,0.00052857,0.00007474/
      DATA (FRACREF(I,26), I = 1, 16)/
     &    0.15439071,0.14895000,0.14181213,0.13153307,
     &    0.11790091,0.10164759,0.08308968,0.06257695,
     &    0.04243122,0.00461873,0.00381206,0.00301578,
     &    0.00221074,0.00140723,0.00052900,0.00007476/
      DATA (FRACREF(I,27), I = 1, 16)/
     &    0.15427324,0.14892800,0.14184241,0.13154215,
     &    0.11793740,0.10169770,0.08309120,0.06257592,
     &    0.04243259,0.00462422,0.00381614,0.00301477,
     &    0.00221235,0.00140759,0.00052950,0.00007477/
      DATA (FRACREF(I,28), I = 1, 16)/
     &    0.15415666,0.14890297,0.14188847,0.13155550,
     &    0.11795072,0.10173480,0.08311173,0.06257526,
     &    0.04243759,0.00462490,0.00382088,0.00301447,
     &    0.00221365,0.00140809,0.00052965,0.00007479/
      DATA (FRACREF(I,29), I = 1, 16)/
     &    0.15403040,0.14889656,0.14192387,0.13156849,
     &    0.11796719,0.10177267,0.08313036,0.06257770,
     &    0.04244067,0.00462425,0.00382516,0.00301515,
     &    0.00221467,0.00140870,0.00052985,0.00007481/
      DATA (FRACREF(I,30), I = 1, 16)/
     &    0.15390140,0.14889988,0.14195195,0.13158163,
     &    0.11798555,0.10180692,0.08314933,0.06258236,
     &    0.04244379,0.00462351,0.00382806,0.00301699,
     &    0.00221515,0.00140917,0.00053012,0.00007483/
      DATA (FRACREF(I,31), I = 1, 16)/
     &    0.15377758,0.14890307,0.14197657,0.13159500,
     &    0.11800456,0.10183278,0.08317091,0.06258827,
     &    0.04244901,0.00462405,0.00382865,0.00302017,
     &    0.00221485,0.00140932,0.00053045,0.00007484/
      DATA (FRACREF(I,32), I = 1, 16)/
     &    0.15366662,0.14890550,0.14200452,0.13159603,
     &    0.11802980,0.10185063,0.08318985,0.06259660,
     &    0.04245288,0.00462578,0.00382891,0.00302322,
     &    0.00221419,0.00141003,0.00053068,0.00007486/
      DATA (FRACREF(I,33), I = 1, 16)/
     &    0.15356180,0.14891671,0.14202477,0.13160117,
     &    0.11805007,0.10186786,0.08320136,0.06260403,
     &    0.04245887,0.00462734,0.00382884,0.00302554,
     &    0.00221408,0.00141062,0.00053082,0.00007488/
      DATA (FRACREF(I,34), I = 1, 16)/
     &    0.15348719,0.14892653,0.14203709,0.13160743,
     &    0.11806169,0.10188067,0.08320937,0.06260937,
     &    0.04246407,0.00462769,0.00382901,0.00302712,
     &    0.00221436,0.00141097,0.00053092,0.00007489/
      DATA (FRACREF(I,35), I = 1, 16)/
     &    0.15345046,0.14893080,0.14204209,0.13161339,
     &    0.11806381,0.10188781,0.08321587,0.06261229,
     &    0.04246730,0.00462649,0.00382964,0.00302802,
     &    0.00221491,0.00141105,0.00053101,0.00007490/
      DATA (FRACREF(I,36), I = 1, 16)/
     &    0.15341459,0.14893475,0.14204697,0.13161923,
     &    0.11806590,0.10189482,0.08322228,0.06261515,
     &    0.04247050,0.00462531,0.00383028,0.00302892,
     &    0.00221545,0.00141114,0.00053110,0.00007490/
      DATA (FRACREF(I,37), I = 1, 16)/
     &    0.15344144,0.14891626,0.14204378,0.13161610,
     &    0.11806508,0.10189252,0.08322337,0.06261403,
     &    0.04247028,0.00462521,0.00383068,0.00302977,
     &    0.00221540,0.00141106,0.00053104,0.00007489/
      DATA (FRACREF(I,38), I = 1, 16)/
     &    0.15346830,0.14889777,0.14204060,0.13161296,
     &    0.11806427,0.10189024,0.08322446,0.06261291,
     &    0.04247006,0.00462512,0.00383108,0.00303062,
     &    0.00221534,0.00141098,0.00053097,0.00007488/
      DATA (FRACREF(I,39), I = 1, 16)/
     &    0.15349515,0.14887927,0.14203741,0.13160983,
     &    0.11806346,0.10188794,0.08322555,0.06261180,
     &    0.04246984,0.00462503,0.00383149,0.00303146,
     &    0.00221529,0.00141090,0.00053091,0.00007487/
      DATA (FRACREF(I,40), I = 1, 16)/
     &    0.15355891,0.14885199,0.14202797,0.13159990,
     &    0.11805699,0.10188453,0.08322565,0.06260653,
     &    0.04246710,0.00462542,0.00383127,0.00303246,
     &    0.00221555,0.00141064,0.00053079,0.00007486/
      DATA (FRACREF(I,41), I = 1, 16)/
     &    0.15362926,0.14882830,0.14201312,0.13158855,
     &    0.11804799,0.10188282,0.08322360,0.06260043,
     &    0.04246444,0.00462562,0.00383159,0.00303314,
     &    0.00221592,0.00141034,0.00053064,0.00007484/
      DATA (FRACREF(I,42), I = 1, 16)/
     &    0.15370318,0.14881155,0.14198981,0.13157688,
     &    0.11803630,0.10188325,0.08321908,0.06259396,
     &    0.04246269,0.00462535,0.00383288,0.00303335,
     &    0.00221633,0.00141004,0.00053047,0.00007483/
      DATA (FRACREF(I,43), I = 1, 16)/
     &    0.15380523,0.14878577,0.14195523,0.13156468,
     &    0.11802206,0.10187780,0.08321843,0.06258541,
     &    0.04246110,0.00462496,0.00383375,0.00303398,
     &    0.00221649,0.00140981,0.00053024,0.00007481/
      DATA (FRACREF(I,44), I = 1, 16)/
     &    0.15394257,0.14873986,0.14191929,0.13154861,
     &    0.11800677,0.10186473,0.08321634,0.06257813,
     &    0.04245967,0.00462450,0.00383350,0.00303546,
     &    0.00221681,0.00140941,0.00052994,0.00007479/
      DATA (FRACREF(I,45), I = 1, 16)/
     &    0.15408684,0.14867294,0.14189301,0.13153593,
     &    0.11799271,0.10185599,0.08321126,0.06256706,
     &    0.04245780,0.00462504,0.00383412,0.00303588,
     &    0.00221782,0.00140899,0.00052968,0.00007476/
      DATA (FRACREF(I,46), I = 1, 16)/
     &    0.15422483,0.14863507,0.14184836,0.13153012,
     &    0.11797418,0.10184189,0.08320562,0.06255554,
     &    0.04245867,0.00462361,0.00383486,0.00303669,
     &    0.00221875,0.00140853,0.00052937,0.00007473/
      DATA (FRACREF(I,47), I = 1, 16)/
     &    0.15438701,0.14859036,0.14180706,0.13150583,
     &    0.11796400,0.10182103,0.08319232,0.06254765,
     &    0.04245761,0.00462346,0.00383408,0.00303717,
     &    0.00222078,0.00140787,0.00052906,0.00007469/
      DATA (FRACREF(I,48), I = 1, 16)/
     &    0.15456381,0.14855400,0.14174680,0.13149074,
     &    0.11794421,0.10179668,0.08318079,0.06253598,
     &    0.04245861,0.00462334,0.00383458,0.00303681,
     &    0.00222272,0.00140733,0.00052864,0.00007466/
      DATA (FRACREF(I,49), I = 1, 16)/
     &    0.15471807,0.14855690,0.14168173,0.13147850,
     &    0.11792427,0.10176561,0.08316395,0.06252953,
     &    0.04245296,0.00462502,0.00383565,0.00303684,
     &    0.00222387,0.00140645,0.00052859,0.00007461/
      DATA (FRACREF(I,50), I = 1, 16)/
     &    0.15486653,0.14856775,0.14161649,0.13146546,
     &    0.11790586,0.10173341,0.08314599,0.06252432,
     &    0.04244581,0.00462704,0.00383673,0.00303697,
     &    0.00222491,0.00140550,0.00052865,0.00007455/
      DATA (FRACREF(I,51), I = 1, 16)/
     &    0.15501499,0.14857861,0.14155126,0.13145241,
     &    0.11788743,0.10170121,0.08312804,0.06251912,
     &    0.04243866,0.00462907,0.00383781,0.00303710,
     &    0.00222596,0.00140455,0.00052870,0.00007450/
      DATA (FRACREF(I,52), I = 1, 16)/
     &    0.15516345,0.14858946,0.14148602,0.13143937,
     &    0.11786901,0.10166901,0.08311008,0.06251392,
     &    0.04243150,0.00463110,0.00383889,0.00303723,
     &    0.00222700,0.00140360,0.00052875,0.00007445/
      DATA (FRACREF(I,53), I = 1, 16)/
     &    0.15531191,0.14860031,0.14142078,0.13142633,
     &    0.11785059,0.10163680,0.08309212,0.06250871,
     &    0.04242435,0.00463313,0.00383997,0.00303736,
     &    0.00222804,0.00140265,0.00052880,0.00007440/
      DATA (FRACREF(I,54), I = 1, 16)/
     &    0.15546039,0.14861117,0.14135554,0.13141328,
     &    0.11783217,0.10160460,0.08307417,0.06250351,
     &    0.04241720,0.00463516,0.00384104,0.00303749,
     &    0.00222908,0.00140170,0.00052885,0.00007435/
      DATA (FRACREF(I,55), I = 1, 16)/
     &    0.15560885,0.14862202,0.14129029,0.13140024,
     &    0.11781374,0.10157239,0.08305620,0.06249830,
     &    0.04241005,0.00463719,0.00384212,0.00303762,
     &    0.00223012,0.00140075,0.00052891,0.00007429/
      DATA (FRACREF(I,56), I = 1, 16)/
     &    0.15575731,0.14863288,0.14122505,0.13138720,
     &    0.11779532,0.10154019,0.08303825,0.06249310,
     &    0.04240290,0.00463922,0.00384320,0.00303775,
     &    0.00223116,0.00139980,0.00052896,0.00007424/
      DATA (FRACREF(I,57), I = 1, 16)/
     &    0.15590577,0.14864373,0.14115982,0.13137415,
     &    0.11777690,0.10150799,0.08302029,0.06248789,
     &    0.04239574,0.00464125,0.00384428,0.00303788,
     &    0.00223220,0.00139886,0.00052901,0.00007419/
      DATA (FRACREF(I,58), I = 1, 16)/
     &    0.15605423,0.14865458,0.14109458,0.13136111,
     &    0.11775848,0.10147579,0.08300234,0.06248269,
     &    0.04238859,0.00464328,0.00384536,0.00303801,
     &    0.00223324,0.00139791,0.00052906,0.00007414/
      DATA (FRACREF(I,59), I = 1, 16)/
     &    0.15620270,0.14866544,0.14102934,0.13134806,
     &    0.11774006,0.10144359,0.08298438,0.06247749,
     &    0.04238144,0.00464531,0.00384644,0.00303814,
     &    0.00223428,0.00139696,0.00052911,0.00007409/

      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB
      STRRAT1 = 866.9486
      STRRAT2 = 32.959

C     Compute the optical depth by interpolating in ln(pressure),
C     temperature, and appropriate species.  Below LAYTROP, the water 
C     vapor self-continuum is interpolated (in temperature) separately.
      DO 2500 LAY = 1, LAYTROP
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLCO2(LAY)
         SPECPARM = COLH2O(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         DO 2300 IREF = 2, 6
            IF(SPECPARM .LE. SPARM41(IREF,JP(LAY))) GO TO 2350
 2300    CONTINUE
 2350    CONTINUE
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(4) + IREF - 1
	 FS = (SPECPARM - SPARM41(IREF-1,JP(LAY))) /
     &        (SPARM41(IREF,JP(LAY)) - SPARM41(IREF-1,JP(LAY)))
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         JP1 = JP(LAY) + 1
         DO 2400 IREF = 2, 6
            IF(SPECPARM .LE. SPARM41(IREF,JP1)) GO TO 2450
 2400    CONTINUE
 2450    CONTINUE
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(4) + IREF - 1
	 FS1 = (SPECPARM - SPARM41(IREF-1,JP1)) /
     &        (SPARM41(IREF,JP1) - SPARM41(IREF-1,JP1))
         FAC001 = (1. - FS1) * FAC01(LAY)
         FAC011 = (1. - FS1) * FAC11(LAY)
         FAC101 = FS1 * FAC01(LAY)
         FAC111 = FS1 * FAC11(LAY)
         INDS = INDSELF(LAY)
         SPECMULT = 8. * SPECPARM
         INDPLNK = 1 + INT(SPECMULT)
         FRACPLNK = AMOD(SPECMULT,1.0)
C     Get rid of this when FRACREF is replaced with FRACREFA, B.
         FP = FAC11(LAY) + FAC01(LAY)
         JJP = JP1 - 1
         IF (FP .GE. 0.5) JJP = JP1
         DO 2000 IG = 1, NG(4)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSA(IND0,IG) +
     &           FAC100 * ABSA(IND0+1,IG) +
     &           FAC010 * ABSA(IND0+7,IG) +
     &           FAC110 * ABSA(IND0+8,IG) +
     &           FAC001 * ABSA(IND1,IG) + 
     &           FAC101 * ABSA(IND1+1,IG) +
     &           FAC011 * ABSA(IND1+7,IG) +
     &           FAC111 * ABSA(IND1+8,IG)) +
     &           COLH2O(LAY) * 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG)))
         FRACS(LAY,IG) = FRACREF(IG,JJP)
C         FRACS(LAY,IG) = FRACREFA(IG,INDPLNK) + FRACPLNK *
C     &           (FRACREFA(IG,INDPLNK+1) - FRACREFA(IG,INDPLNK))
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         SPECCOMB = COLO3(LAY) + STRRAT2*COLCO2(LAY)
         SPECPARM = COLO3(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         IREF = 3
         IF(SPECPARM .LE. SPARM42(2,JP(LAY))) IREF = 2
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(4) + IREF - 1
	 FS = (SPECPARM - SPARM42(IREF-1,JP(LAY))) /
     &        (SPARM42(IREF,JP(LAY)) - SPARM42(IREF-1,JP(LAY)))
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         JP1 = JP(LAY) + 1
         IREF = 3
         IF(SPECPARM .LE. SPARM42(2,JP1)) IREF = 2
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(4) + IREF - 1
	 FS1 = (SPECPARM - SPARM42(IREF-1,JP1)) /
     &        (SPARM42(IREF,JP1) - SPARM42(IREF-1,JP1))
         FAC001 = (1. - FS1) * FAC01(LAY)
         FAC011 = (1. - FS1) * FAC11(LAY)
         FAC101 = FS1 * FAC01(LAY)
         FAC111 = FS1 * FAC11(LAY)
         SPECMULT = 4. * SPECPARM
         INDPLNK = 1 + INT(SPECMULT)
         FRACPLNK = AMOD(SPECMULT,1.0)
C     Get rid of this when FRACREF is replaced with FRACREFA, B.
         FP = FAC11(LAY) + FAC01(LAY)
         JJP = JP1 - 1
         IF (FP .GE. 0.5) JJP = JP1
         DO 3000 IG = 1, NG(4)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSB(IND0,IG) +
     &           FAC100 * ABSB(IND0+1,IG) +
     &           FAC010 * ABSB(IND0+3,IG) +
     &           FAC110 * ABSB(IND0+4,IG) +
     &           FAC001 * ABSB(IND1,IG) + 
     &           FAC101 * ABSB(IND1+1,IG) +
     &           FAC011 * ABSB(IND1+3,IG) +
     &           FAC111 * ABSB(IND1+4,IG))
         FRACS(LAY,IG) = FRACREF(IG,JJP)
C         FRACS(LAY,IG) = FRACREFB(IG,INDPLNK) + FRACPLNK *
C     &           (FRACREFB(IG,INDPLNK+1) - FRACREFB(IG,INDPLNK))
 3000    CONTINUE 
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB5

C     BAND 5:  700-820 cm-1 (low - H2O,CO2; high - O3,CO2)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PRECISE/  ONEMINUS
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K5/       KA(7,5,13,MG), KB(3,5,13:59,MG) , SELFREF(10,MG)

      DIMENSION SPARM51(7,13),SPARM52(3,13:59)
      DIMENSION ABSA(455,MG),ABSB(705,MG)
      DIMENSION FRACREF(MG,59)

      DATA SPARM51 / 
     &0.0,.16414E+0,.28200E+0,.37073E+0,.43994E+0,.49543E+0,.54092E+0,
     &0.0,.13908E+0,.24420E+0,.32644E+0,.39254E+0,.44682E+0,.49220E+0,
     &0.0,.96695E-1,.17634E+0,.24308E+0,.29981E+0,.34863E+0,.39109E+0,
     &0.0,.60744E-1,.11453E+0,.16249E+0,.20552E+0,.24435E+0,.27956E+0,
     &0.0,.36353E-1,.70156E-1,.10167E+0,.13111E+0,.15869E+0,.18457E+0,
     &0.0,.19866E-1,.38958E-1,.57321E-1,.74995E-1,.92018E-1,.10843E+0,
     &0.0,.10258E-1,.20308E-1,.30156E-1,.39807E-1,.49269E-1,.58546E-1,
     &0.0,.50933E-2,.10135E-1,.15126E-1,.20067E-1,.24958E-1,.29801E-1,
     &0.0,.23864E-2,.47614E-2,.71252E-2,.94777E-2,.11819E-1,.14150E-1,
     &0.0,.92566E-3,.18496E-2,.27718E-2,.36924E-2,.46112E-2,.55284E-2,
     &0.0,.57488E-3,.11491E-2,.17227E-2,.22956E-2,.28678E-2,.34394E-2,
     &0.0,.14293E-3,.28582E-3,.42867E-3,.57148E-3,.71425E-3,.85697E-3,
     &0.0,.10384E-3,.20766E-3,.31146E-3,.41524E-3,.51900E-3,.62273E-3/

      DATA SPARM52 / 
     &0.0,.23834E-02,.47556E-02,0.0,.38249E-02,.76206E-02,
     &0.0,.60106E-02,.11949E-01,0.0,.79234E-02,.15722E-01,
     &0.0,.10050E-01,.19900E-01,0.0,.12404E-01,.24504E-01,
     &0.0,.15527E-01,.30579E-01,0.0,.17929E-01,.35227E-01,
     &0.0,.20053E-01,.39317E-01,0.0,.21861E-01,.42786E-01,
     &0.0,.23671E-01,.46246E-01,0.0,.25721E-01,.50153E-01,
     &0.0,.27562E-01,.53646E-01,0.0,.29022E-01,.56408E-01,
     &0.0,.29424E-01,.57166E-01,0.0,.29044E-01,.56448E-01,
     &0.0,.27032E-01,.52640E-01,0.0,.24544E-01,.47912E-01,
     &0.0,.21200E-01,.41519E-01,0.0,.18089E-01,.35535E-01,
     &0.0,.15154E-01,.29855E-01,0.0,.13006E-01,.25678E-01,
     &0.0,.11142E-01,.22038E-01,0.0,.95983E-02,.19014E-01,
     &0.0,.84762E-02,.16810E-01,0.0,.73747E-02,.14641E-01,
     &0.0,.62707E-02,.12463E-01,0.0,.56716E-02,.11279E-01,
     &0.0,.51397E-02,.10227E-01,0.0,.46073E-02,.91723E-02,
     &0.0,.40923E-02,.81513E-02,0.0,.35850E-02,.71443E-02,
     &0.0,.30771E-02,.61353E-02,0.0,.26135E-02,.52134E-02,
     &0.0,.22391E-02,.44681E-02,0.0,.18644E-02,.37218E-02,
     &0.0,.14894E-02,.29743E-02,0.0,.12485E-02,.24939E-02,
     &0.0,.10695E-02,.21368E-02,0.0,.89047E-03,.17794E-02,
     &0.0,.71135E-03,.14217E-02,0.0,.65725E-03,.13136E-02,
     &0.0,.66556E-03,.13302E-02,0.0,.67389E-03,.13469E-02,
     &0.0,.68223E-03,.13635E-02,0.0,.71244E-03,.14239E-02,
     &0.0,.97699E-03,.19521E-02/

      DATA (FRACREF(I, 1), I = 1, 16)/
     &    0.14521869,0.14651436,0.14037277,0.13289870,
     &    0.12013174,0.10415110,0.08578248,0.06470173,
     &    0.04386929,0.00476479,0.00398803,0.00315888,
     &    0.00232635,0.00148398,0.00055873,0.00007931/
      DATA (FRACREF(I, 2), I = 1, 16)/
     &    0.14456999,0.14601132,0.13975726,0.13257995,
     &    0.12042715,0.10458459,0.08617908,0.06512564,
     &    0.04424074,0.00483481,0.00402875,0.00318356,
     &    0.00233030,0.00149895,0.00056706,0.00007988/
      DATA (FRACREF(I, 3), I = 1, 16)/
     &    0.14375019,0.14535886,0.13894100,0.13224477,
     &    0.12086315,0.10496060,0.08682957,0.06571562,
     &    0.04465352,0.00490737,0.00405993,0.00320350,
     &    0.00234666,0.00151228,0.00057250,0.00008059/
      DATA (FRACREF(I, 4), I = 1, 16)/
     &    0.14275697,0.14448999,0.13815598,0.13184921,
     &    0.12131245,0.10557380,0.08762657,0.06633858,
     &    0.04507822,0.00495021,0.00408826,0.00322858,
     &    0.00236516,0.00152729,0.00057821,0.00008141/
      DATA (FRACREF(I, 5), I = 1, 16)/
     &    0.14156406,0.14354056,0.13772555,0.13139540,
     &    0.12173516,0.10628981,0.08841320,0.06689374,
     &    0.04548429,0.00498892,0.00412154,0.00325559,
     &    0.00238021,0.00154557,0.00058428,0.00008228/
      DATA (FRACREF(I, 6), I = 1, 16)/
     &    0.14019163,0.14245299,0.13732357,0.13090779,
     &    0.12237271,0.10705011,0.08918755,0.06754061,
     &    0.04587907,0.00501519,0.00415831,0.00328384,
     &    0.00240047,0.00156226,0.00059102,0.00008325/
      DATA (FRACREF(I, 7), I = 1, 16)/
     &    0.13863866,0.14138918,0.13690805,0.13030322,
     &    0.12323283,0.10782276,0.08997516,0.06822657,
     &    0.04626950,0.00504019,0.00419763,0.00331253,
     &    0.00242356,0.00157801,0.00059821,0.00008428/
      DATA (FRACREF(I, 8), I = 1, 16)/
     &    0.13699402,0.14001329,0.13662967,0.13008066,
     &    0.12388857,0.10856293,0.09082932,0.06894048,
     &    0.04668051,0.00508066,0.00422322,0.00334532,
     &    0.00244472,0.00159509,0.00060562,0.00008537/
      DATA (FRACREF(I, 9), I = 1, 16)/
     &    0.13529848,0.13860647,0.13611419,0.13017760,
     &    0.12441771,0.10934918,0.09178063,0.06960141,
     &    0.04712134,0.00512601,0.00424884,0.00338067,
     &    0.00246655,0.00161124,0.00061332,0.00008651/
      DATA (FRACREF(I,10), I = 1, 16)/
     &    0.13410665,0.13760422,0.13560815,0.13022789,
     &    0.12471672,0.11003790,0.09247447,0.07009924,
     &    0.04746953,0.00516565,0.00427097,0.00340401,
     &    0.00248651,0.00162121,0.00061945,0.00008743/
      DATA (FRACREF(I,11), I = 1, 16)/
     &    0.13397902,0.13763031,0.13535476,0.13040401,
     &    0.12460633,0.11016248,0.09257004,0.07011104,
     &    0.04752775,0.00516643,0.00428046,0.00339308,
     &    0.00249048,0.00161663,0.00062017,0.00008756/
      DATA (FRACREF(I,12), I = 1, 16)/
     &    0.13400714,0.13780613,0.13532266,0.13067828,
     &    0.12434006,0.11016341,0.09246597,0.07005914,
     &    0.04752170,0.00516369,0.00428014,0.00338353,
     &    0.00249110,0.00161009,0.00061981,0.00008756/
      DATA (FRACREF(I,13), I = 1, 16)/
     &    0.13408656,0.13801523,0.13544749,0.13095061,
     &    0.12407376,0.11004096,0.09229396,0.06999186,
     &    0.04748852,0.00515985,0.00427556,0.00337908,
     &    0.00248685,0.00160397,0.00061910,0.00008752/
      DATA (FRACREF(I,14), I = 1, 16)/
     &    0.13432342,0.13824171,0.13583814,0.13125476,
     &    0.12377882,0.10981987,0.09192307,0.06984301,
     &    0.04740108,0.00515620,0.00426580,0.00337491,
     &    0.00247856,0.00159637,0.00061762,0.00008734/
      DATA (FRACREF(I,15), I = 1, 16)/
     &    0.13463630,0.13849781,0.13626333,0.13167456,
     &    0.12349276,0.10966381,0.09133632,0.06961043,
     &    0.04728908,0.00515082,0.00425552,0.00336734,
     &    0.00247076,0.00158889,0.00061569,0.00008708/
      DATA (FRACREF(I,16), I = 1, 16)/
     &    0.13496035,0.13871761,0.13657545,0.13216656,
     &    0.12330609,0.10946216,0.09090203,0.06922109,
     &    0.04719117,0.00514306,0.00424949,0.00335921,
     &    0.00246551,0.00157991,0.00061369,0.00008683/
      DATA (FRACREF(I,17), I = 1, 16)/
     &    0.13525908,0.13895985,0.13680075,0.13263638,
     &    0.12313630,0.10942309,0.09046700,0.06876644,
     &    0.04708986,0.00513486,0.00424405,0.00335104,
     &    0.00246166,0.00157435,0.00060897,0.00008659/
      DATA (FRACREF(I,18), I = 1, 16)/
     &    0.13554429,0.13920230,0.13696553,0.13301697,
     &    0.12315287,0.10927310,0.09015261,0.06835438,
     &    0.04691121,0.00512441,0.00423789,0.00334653,
     &    0.00245665,0.00156967,0.00060472,0.00008636/
      DATA (FRACREF(I,19), I = 1, 16)/
     &    0.13582540,0.13942063,0.13714162,0.13332361,
     &    0.12325536,0.10908554,0.08987585,0.06799528,
     &    0.04668349,0.00511586,0.00423079,0.00334244,
     &    0.00245139,0.00156532,0.00060125,0.00008612/
      DATA (FRACREF(I,20), I = 1, 16)/
     &    0.13613799,0.13963449,0.13737075,0.13343984,
     &    0.12337545,0.10891063,0.08963268,0.06768363,
     &    0.04645548,0.00510786,0.00422260,0.00333738,
     &    0.00244639,0.00156099,0.00059811,0.00008585/
      DATA (FRACREF(I,21), I = 1, 16)/
     &    0.13650469,0.13987616,0.13758667,0.13347402,
     &    0.12345447,0.10874061,0.08940921,0.06741087,
     &    0.04622535,0.00509514,0.00421448,0.00333048,
     &    0.00244120,0.00155644,0.00059510,0.00008556/
      DATA (FRACREF(I,22), I = 1, 16)/
     &    0.13695832,0.14016017,0.13779351,0.13350160,
     &    0.12343237,0.10858184,0.08915503,0.06716502,
     &    0.04598668,0.00507607,0.00420444,0.00332188,
     &    0.00243543,0.00155135,0.00059174,0.00008522/
      DATA (FRACREF(I,23), I = 1, 16)/
     &    0.13746211,0.14047541,0.13798733,0.13351247,
     &    0.12334801,0.10841428,0.08889472,0.06694876,
     &    0.04575383,0.00505280,0.00419030,0.00331245,
     &    0.00242941,0.00154600,0.00058827,0.00008483/
      DATA (FRACREF(I,24), I = 1, 16)/
     &    0.13797194,0.14079030,0.13820450,0.13347726,
     &    0.12326366,0.10819840,0.08867069,0.06675711,
     &    0.04553454,0.00502165,0.00417368,0.00330395,
     &    0.00242221,0.00154146,0.00058503,0.00008444/
      DATA (FRACREF(I,25), I = 1, 16)/
     &    0.13850404,0.14111696,0.13841192,0.13342880,
     &    0.12313969,0.10795670,0.08847948,0.06657002,
     &    0.04533961,0.00498885,0.00415359,0.00329329,
     &    0.00241459,0.00153639,0.00058214,0.00008405/
      DATA (FRACREF(I,26), I = 1, 16)/
     &    0.13904287,0.14144427,0.13861607,0.13336876,
     &    0.12299625,0.10771975,0.08829185,0.06638797,
     &    0.04515861,0.00495864,0.00413245,0.00328078,
     &    0.00240717,0.00153129,0.00057945,0.00008365/
      DATA (FRACREF(I,27), I = 1, 16)/
     &    0.13958615,0.14176954,0.13881768,0.13329522,
     &    0.12283329,0.10749570,0.08810184,0.06621243,
     &    0.04499237,0.00493268,0.00411060,0.00326613,
     &    0.00240009,0.00152627,0.00057700,0.00008324/
      DATA (FRACREF(I,28), I = 1, 16)/
     &    0.14012186,0.14207286,0.13901532,0.13323832,
     &    0.12261700,0.10727274,0.08792384,0.06606104,
     &    0.04485071,0.00491459,0.00408851,0.00325299,
     &    0.00239189,0.00152112,0.00057480,0.00008286/
      DATA (FRACREF(I,29), I = 1, 16)/
     &    0.14065500,0.14236754,0.13919705,0.13319062,
     &    0.12239476,0.10705019,0.08774567,0.06591642,
     &    0.04472189,0.00489673,0.00407115,0.00323972,
     &    0.00238256,0.00151616,0.00057254,0.00008248/
      DATA (FRACREF(I,30), I = 1, 16)/
     &    0.14118721,0.14264995,0.13936226,0.13316174,
     &    0.12216847,0.10682195,0.08756953,0.06577703,
     &    0.04460291,0.00487997,0.00405738,0.00322565,
     &    0.00237271,0.00151124,0.00057039,0.00008211/
      DATA (FRACREF(I,31), I = 1, 16)/
     &    0.14171961,0.14291693,0.13950983,0.13316138,
     &    0.12194132,0.10658171,0.08739758,0.06564102,
     &    0.04449053,0.00486515,0.00404591,0.00321017,
     &    0.00236302,0.00150623,0.00056852,0.00008176/
      DATA (FRACREF(I,32), I = 1, 16)/
     &    0.14222980,0.14319754,0.13962632,0.13316028,
     &    0.12174764,0.10634107,0.08722263,0.06550422,
     &    0.04438671,0.00484942,0.00403489,0.00319711,
     &    0.00235347,0.00150161,0.00056674,0.00008141/
      DATA (FRACREF(I,33), I = 1, 16)/
     &    0.14270502,0.14345954,0.13973248,0.13315861,
     &    0.12159951,0.10611865,0.08703273,0.06537171,
     &    0.04428918,0.00483866,0.00402362,0.00318319,
     &    0.00234490,0.00149738,0.00056496,0.00008107/
      DATA (FRACREF(I,34), I = 1, 16)/
     &    0.14302351,0.14362906,0.13979393,0.13316539,
     &    0.12151876,0.10597515,0.08689649,0.06527982,
     &    0.04422144,0.00483233,0.00401460,0.00317326,
     &    0.00233829,0.00149451,0.00056376,0.00008084/
      DATA (FRACREF(I,35), I = 1, 16)/
     &    0.14314672,0.14368245,0.13979986,0.13318376,
     &    0.12150900,0.10592973,0.08683857,0.06524058,
     &    0.04419099,0.00482979,0.00400871,0.00316905,
     &    0.00233387,0.00149330,0.00056332,0.00008076/
      DATA (FRACREF(I,36), I = 1, 16)/
     &    0.14326534,0.14373326,0.13980418,0.13320269,
     &    0.12150061,0.10588676,0.08678253,0.06520258,
     &    0.04416137,0.00482736,0.00400295,0.00316490,
     &    0.00232953,0.00149213,0.00056289,0.00008068/
      DATA (FRACREF(I,37), I = 1, 16)/
     &    0.14305276,0.14359787,0.13969278,0.13326328,
     &    0.12159162,0.10602082,0.08686227,0.06525455,
     &    0.04419196,0.00483214,0.00400570,0.00316574,
     &    0.00233027,0.00149385,0.00056359,0.00008080/
      DATA (FRACREF(I,38), I = 1, 16)/
     &    0.14284018,0.14346248,0.13958137,0.13332386,
     &    0.12168262,0.10615487,0.08694202,0.06530651,
     &    0.04422256,0.00483693,0.00400845,0.00316658,
     &    0.00233102,0.00149557,0.00056429,0.00008093/
      DATA (FRACREF(I,39), I = 1, 16)/
     &    0.14262760,0.14332710,0.13946997,0.13338444,
     &    0.12177363,0.10628893,0.08702177,0.06535847,
     &    0.04425315,0.00484172,0.00401121,0.00316742,
     &    0.00233176,0.00149728,0.00056499,0.00008105/
      DATA (FRACREF(I,40), I = 1, 16)/
     &    0.14221531,0.14307237,0.13930409,0.13344641,
     &    0.12193864,0.10652027,0.08718802,0.06547652,
     &    0.04431409,0.00485063,0.00401867,0.00317223,
     &    0.00233507,0.00150082,0.00056635,0.00008131/
      DATA (FRACREF(I,41), I = 1, 16)/
     &    0.14174685,0.14278384,0.13911903,0.13351250,
     &    0.12212097,0.10678107,0.08738126,0.06561387,
     &    0.04438271,0.00486006,0.00402688,0.00317826,
     &    0.00233912,0.00150492,0.00056793,0.00008160/
      DATA (FRACREF(I,42), I = 1, 16)/
     &    0.14123400,0.14246766,0.13891432,0.13358457,
     &    0.12231292,0.10706874,0.08759921,0.06576671,
     &    0.04445769,0.00486944,0.00403527,0.00318524,
     &    0.00234384,0.00150950,0.00056969,0.00008193/
      DATA (FRACREF(I,43), I = 1, 16)/
     &    0.14061701,0.14208442,0.13867205,0.13365524,
     &    0.12253521,0.10741962,0.08787031,0.06595195,
     &    0.04455472,0.00488117,0.00404636,0.00319370,
     &    0.00235033,0.00151480,0.00057179,0.00008235/
      DATA (FRACREF(I,44), I = 1, 16)/
     &    0.13990106,0.14163336,0.13840781,0.13369627,
     &    0.12280219,0.10783438,0.08818850,0.06616850,
     &    0.04467448,0.00489439,0.00405908,0.00320368,
     &    0.00235867,0.00152086,0.00057418,0.00008280/
      DATA (FRACREF(I,45), I = 1, 16)/
     &    0.13914576,0.14117083,0.13813367,0.13369817,
     &    0.12311488,0.10825308,0.08853623,0.06639531,
     &    0.04480200,0.00490971,0.00407090,0.00321487,
     &    0.00236798,0.00152725,0.00057674,0.00008331/
      DATA (FRACREF(I,46), I = 1, 16)/
     &    0.13830248,0.14065374,0.13782279,0.13369653,
     &    0.12346680,0.10871220,0.08893363,0.06665197,
     &    0.04494519,0.00492460,0.00408524,0.00322906,
     &    0.00237796,0.00153402,0.00057962,0.00008387/
      DATA (FRACREF(I,47), I = 1, 16)/
     &    0.13731357,0.14006937,0.13744788,0.13368645,
     &    0.12386630,0.10923484,0.08941963,0.06695218,
     &    0.04511796,0.00494458,0.00410440,0.00324410,
     &    0.00239025,0.00154205,0.00058291,0.00008449/
      DATA (FRACREF(I,48), I = 1, 16)/
     &    0.13624264,0.13946682,0.13703263,0.13366725,
     &    0.12427321,0.10982158,0.08993955,0.06727757,
     &    0.04530252,0.00496823,0.00412271,0.00326163,
     &    0.00240269,0.00155098,0.00058630,0.00008517/
      DATA (FRACREF(I,49), I = 1, 16)/
     &    0.13510123,0.13883324,0.13659999,0.13360776,
     &    0.12473356,0.11044272,0.09049583,0.06762103,
     &    0.04550136,0.00498874,0.00413974,0.00328149,
     &    0.00241724,0.00156023,0.00059003,0.00008585/
      DATA (FRACREF(I,50), I = 1, 16)/
     &    0.13395023,0.13819444,0.13616575,0.13354166,
     &    0.12520404,0.11106645,0.09105758,0.06796672,
     &    0.04570263,0.00500827,0.00415687,0.00330146,
     &    0.00243229,0.00156951,0.00059383,0.00008653/
      DATA (FRACREF(I,51), I = 1, 16)/
     &    0.13279924,0.13755564,0.13573153,0.13347554,
     &    0.12567452,0.11169016,0.09161933,0.06831241,
     &    0.04590390,0.00502779,0.00417400,0.00332142,
     &    0.00244734,0.00157878,0.00059763,0.00008720/
      DATA (FRACREF(I,52), I = 1, 16)/
     &    0.13164823,0.13691685,0.13529730,0.13340943,
     &    0.12614499,0.11231388,0.09218108,0.06865810,
     &    0.04610517,0.00504731,0.00419113,0.00334139,
     &    0.00246238,0.00158805,0.00060143,0.00008788/
      DATA (FRACREF(I,53), I = 1, 16)/
     &    0.13049723,0.13627803,0.13486308,0.13334332,
     &    0.12661548,0.11293761,0.09274282,0.06900379,
     &    0.04630644,0.00506684,0.00420826,0.00336135,
     &    0.00247743,0.00159733,0.00060523,0.00008856/
      DATA (FRACREF(I,54), I = 1, 16)/
     &    0.12934624,0.13563924,0.13442884,0.13327721,
     &    0.12708595,0.11356132,0.09330457,0.06934948,
     &    0.04650771,0.00508636,0.00422539,0.00338132,
     &    0.00249248,0.00160660,0.00060902,0.00008923/
      DATA (FRACREF(I,55), I = 1, 16)/
     &    0.12819524,0.13500044,0.13399462,0.13321111,
     &    0.12755644,0.11418505,0.09386632,0.06969517,
     &    0.04670897,0.00510588,0.00424252,0.00340128,
     &    0.00250753,0.00161587,0.00061282,0.00008991/
      DATA (FRACREF(I,56), I = 1, 16)/
     &    0.12704423,0.13436164,0.13356040,0.13314499,
     &    0.12802692,0.11480877,0.09442807,0.07004087,
     &    0.04691024,0.00512541,0.00425965,0.00342125,
     &    0.00252258,0.00162515,0.00061662,0.00009059/
      DATA (FRACREF(I,57), I = 1, 16)/
     &    0.12589324,0.13372284,0.13312617,0.13307887,
     &    0.12849739,0.11543249,0.09498981,0.07038656,
     &    0.04711151,0.00514493,0.00427678,0.00344121,
     &    0.00253763,0.00163442,0.00062042,0.00009126/
      DATA (FRACREF(I,58), I = 1, 16)/
     &    0.12474224,0.13308404,0.13269195,0.13301277,
     &    0.12896788,0.11605621,0.09555157,0.07073225,
     &    0.04731278,0.00516445,0.00429391,0.00346118,
     &    0.00255268,0.00164370,0.00062422,0.00009194/
      DATA (FRACREF(I,59), I = 1, 16)/
     &    0.12359124,0.13244525,0.13225771,0.13294666,
     &    0.12943836,0.11667993,0.09611332,0.07107794,
     &    0.04751405,0.00518398,0.00431104,0.00348114,
     &    0.00256772,0.00165297,0.00062801,0.00009262/

      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB
      STRRAT1 = 86.9028
      STRRAT2 = 0.820692

C     Compute the optical depth by interpolating in ln(pressure), 
C     temperature, and appropriate species.  Below LAYTROP, the water 
C     vapor self-continuum is interpolated (in temperature) separately.
      DO 2500 LAY = 1, LAYTROP
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLCO2(LAY)
         SPECPARM = COLH2O(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         DO 2300 IREF = 2, 6
            IF(SPECPARM .LE. SPARM51(IREF,JP(LAY))) GO TO 2350
 2300    CONTINUE
 2350    CONTINUE
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(5) + IREF - 1
	 FS = (SPECPARM - SPARM51(IREF-1,JP(LAY))) /
     &        (SPARM51(IREF,JP(LAY)) - SPARM51(IREF-1,JP(LAY)))
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         JP1 = JP(LAY) + 1
         DO 2400 IREF = 2, 6
            IF(SPECPARM .LE. SPARM51(IREF,JP1)) GO TO 2450
 2400    CONTINUE
 2450    CONTINUE
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(5) + IREF - 1
	 FS1 = (SPECPARM - SPARM51(IREF-1,JP1)) /
     &        (SPARM51(IREF,JP1) - SPARM51(IREF-1,JP1))
         FAC001 = (1. - FS1) * FAC01(LAY)
         FAC011 = (1. - FS1) * FAC11(LAY)
         FAC101 = FS1 * FAC01(LAY)
         FAC111 = FS1 * FAC11(LAY)
         INDS = INDSELF(LAY)
         SPECMULT = 8. * SPECPARM
         INDPLNK = 1 + INT(SPECMULT)
         FRACPLNK = AMOD(SPECMULT,1.0)
C     Get rid of this when FRACREF is replaced with FRACREFA, B.
         FP = FAC11(LAY) + FAC01(LAY)
         JJP = JP1 - 1
         IF (FP .GE. 0.5) JJP = JP1
         DO 2000 IG = 1, NG(5)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSA(IND0,IG) +
     &           FAC100 * ABSA(IND0+1,IG) +
     &           FAC010 * ABSA(IND0+7,IG) +
     &           FAC110 * ABSA(IND0+8,IG) +
     &           FAC001 * ABSA(IND1,IG) + 
     &           FAC101 * ABSA(IND1+1,IG) +
     &           FAC011 * ABSA(IND1+7,IG) +
     &           FAC111 * ABSA(IND1+8,IG)) +
     &           COLH2O(LAY) * 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG))) 
         FRACS(LAY,IG) = FRACREF(IG,JJP)
C         FRACS(LAY,IG) = FRACREFA(IG,INDPLNK) + FRACPLNK *
C     &           (FRACREFA(IG,INDPLNK+1) - FRACREFA(IG,INDPLNK))
2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         SPECCOMB = COLO3(LAY) + STRRAT2*COLCO2(LAY)
         SPECPARM = COLO3(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         IREF = 3
         IF(SPECPARM .LE. SPARM52(2,JP(LAY))) IREF = 2
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(5) + IREF - 1
	 FS = (SPECPARM - SPARM52(IREF-1,JP(LAY))) /
     &        (SPARM52(IREF,JP(LAY)) - SPARM52(IREF-1,JP(LAY)))
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         JP1 = JP(LAY) + 1
         IREF = 3
         IF(SPECPARM .LE. SPARM52(2,JP1)) IREF = 2
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(5) + IREF - 1
	 FS1 = (SPECPARM - SPARM52(IREF-1,JP1)) /
     &        (SPARM52(IREF,JP1) - SPARM52(IREF-1,JP1))
         FAC001 = (1. - FS1) * FAC01(LAY)
         FAC011 = (1. - FS1) * FAC11(LAY)
         FAC101 = FS1 * FAC01(LAY)
         FAC111 = FS1 * FAC11(LAY)
         SPECMULT = 4. * SPECPARM
         INDPLNK = 1 + INT(SPECMULT)
         FRACPLNK = AMOD(SPECMULT,1.0)
C     Get rid of this when FRACREF is replaced with FRACREFA, B.
         FP = FAC11(LAY) + FAC01(LAY)
         JJP = JP1 - 1
         IF (FP .GE. 0.5) JJP = JP1
         DO 3000 IG = 1, NG(5)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSB(IND0,IG) +
     &           FAC100 * ABSB(IND0+1,IG) +
     &           FAC010 * ABSB(IND0+3,IG) +
     &           FAC110 * ABSB(IND0+4,IG) +
     &           FAC001 * ABSB(IND1,IG) + 
     &           FAC101 * ABSB(IND1+1,IG) +
     &           FAC011 * ABSB(IND1+3,IG) +
     &           FAC111 * ABSB(IND1+4,IG))
         FRACS(LAY,IG) = FRACREF(IG,JJP)
C         FRACS(LAY,IG) = FRACREFB(IG,INDPLNK) + FRACPLNK *
C     &           (FRACREFB(IG,INDPLNK+1) - FRACREFB(IG,INDPLNK))
 3000    CONTINUE 
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB6

C     BAND 6:  820-980 cm-1 (low - H2O; high - nothing)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K6/       KA(5,13,MG), SELFREF(10,MG)

      DIMENSION ABSA(65,MG)
      DIMENSION FRACREFA(MG)

C     From P = 706 mb.
      DATA FRACREFA/
     &    0.13739009,0.14259538,0.14033118,0.13547136,
     &    0.12569460,0.11028396,0.08626066,0.06245148,
     &    0.04309394,0.00473551,0.00403920,0.00321695,
     &    0.00232470,0.00147662,0.00056095,0.00007373/

      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB

C     Compute the optical depth by interpolating in ln(pressure) and
C     temperature. The water vapor self-continuum is interpolated
C     (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(6) + 1
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(6) + 1
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(6)
            TAUG(LAY,IG) = COLH2O(LAY) * 
     &          (FAC00(LAY) * ABSA(IND0,IG) +
     &           FAC10(LAY) * ABSA(IND0+1,IG) +
     &           FAC01(LAY) * ABSA(IND1,IG) + 
     &           FAC11(LAY) * ABSA(IND1+1,IG) + 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY)*
     &           (SELFREF(INDS+1,IG)-SELFREF(INDS,IG))))
            FRACS(LAY,IG) = FRACREFA(IG)
 2000    CONTINUE
 2500 CONTINUE

C     Nothing important goes on above LAYTROP in this band.
      DO 3500 LAY = LAYTROP+1, NLAYERS
         DO 3000 IG = 1, NG(6)
            TAUG(LAY,IG) = 0.0
            FRACS(LAY,IG) = 0.0
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB7

C     BAND 7:  980-1080 cm-1 (low - H2O,O3; high - O3)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PRECISE/  ONEMINUS
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K7/       KA(9,5,13,MG), KB(5,13:59,MG) , SELFREF(10,MG)

      DIMENSION ABSA(585,MG),ABSB(235,MG)
      DIMENSION FRACREFA(MG,9),FRACREFB(MG)

      DATA FRACREFA/
     &  0.16461779, 0.14889984, 0.14233345, 0.13156526,
     &  0.11679733, 0.09988949, 0.08078653, 0.06006384,
     &  0.04028391, 0.00435899, 0.00359173, 0.00281707,
     &  0.00206767, 0.00135012, 0.00050720, 0.00007146,
     &  0.16442357, 0.14944240, 0.14245804, 0.13111183,
     &  0.11688625, 0.09983791, 0.08085148, 0.05993948,
     &  0.04028057, 0.00435939, 0.00358708, 0.00284036,
     &  0.00208869, 0.00133256, 0.00049260, 0.00006931,
     &  0.16368519, 0.15018989, 0.14262174, 0.13084342,
     &  0.11682195, 0.09996257, 0.08074036, 0.05985692,
     &  0.04045362, 0.00436208, 0.00358257, 0.00287122,
     &  0.00211004, 0.00133804, 0.00049260, 0.00006931,
     &  0.16274056, 0.15133780, 0.14228874, 0.13081114,
     &  0.11688486, 0.09979610, 0.08073687, 0.05996741,
     &  0.04040616, 0.00439869, 0.00368910, 0.00293041,
     &  0.00211604, 0.00133536, 0.00049260, 0.00006931,
     &  0.16176532, 0.15207882, 0.14226955, 0.13079646,
     &  0.11688191, 0.09966998, 0.08066384, 0.06020275,
     &  0.04047901, 0.00446696, 0.00377456, 0.00294410,
     &  0.00211082, 0.00133536, 0.00049260, 0.00006931,
     &  0.15993737, 0.15305527, 0.14259829, 0.13078023,
     &  0.11686983, 0.09980131, 0.08058286, 0.06031430,
     &  0.04082833, 0.00450509, 0.00377574, 0.00294823,
     &  0.00210977, 0.00133302, 0.00049260, 0.00006931,
     &  0.15371189, 0.15592396, 0.14430280, 0.13076764,
     &  0.11720382, 0.10023471, 0.08066396, 0.06073554,
     &  0.04121581, 0.00451202, 0.00377832, 0.00294609,
     &  0.00210943, 0.00133336, 0.00049260, 0.00006931,
     &  0.14262275, 0.14572631, 0.14560597, 0.13736825,
     &  0.12271351, 0.10419556, 0.08294533, 0.06199794,
     &  0.04157615, 0.00452842, 0.00377704, 0.00293852,
     &  0.00211034, 0.00133278, 0.00049259, 0.00006931,
     &  0.14500433, 0.14590444, 0.14430299, 0.13770708,
     &  0.12288283, 0.10350952, 0.08269450, 0.06130579,
     &  0.04144571, 0.00452096, 0.00377382, 0.00294532,
     &  0.00210943, 0.00133228, 0.00049260, 0.00006931/

      DATA FRACREFB/
     &    0.15355594,0.15310939,0.14274909,0.13129812,
     &    0.11736792,0.10118213,0.08215259,0.06165591,
     &    0.04164486,0.00451141,0.00372837,0.00294095,
     &    0.00215259,0.00136792,0.00051233,0.00007075/

      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB
      STRRAT1 = 8.21104E4

C     Compute the optical depth by interpolating in ln(pressure), 
C     temperature, and appropriate species.  Below LAYTROP, the water
C     vapor self-continuum is interpolated (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLO3(LAY)
         SPECPARM = COLH2O(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         SPECMULT = 8.*SPECPARM
         JS = 1 + INT(SPECMULT)
	 FS = AMOD(SPECMULT,1.0)
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         FAC001 = (1. - FS) * FAC01(LAY)
         FAC011 = (1. - FS) * FAC11(LAY)
         FAC101 = FS * FAC01(LAY)
         FAC111 = FS * FAC11(LAY)
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(7) + JS
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(7) + JS
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(7)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSA(IND0,IG) +
     &           FAC100 * ABSA(IND0+1,IG) +
     &           FAC010 * ABSA(IND0+9,IG) +
     &           FAC110 * ABSA(IND0+10,IG) +
     &           FAC001 * ABSA(IND1,IG) + 
     &           FAC101 * ABSA(IND1+1,IG) +
     &           FAC011 * ABSA(IND1+9,IG) +
     &           FAC111 * ABSA(IND1+10,IG)) +
     &           COLH2O(LAY) * 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG)))
         FRACS(LAY,IG) = FRACREFA(IG,JS) + FS *
     &           (FRACREFA(IG,JS+1) - FRACREFA(IG,JS))
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(7) + 1
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(7) + 1
         DO 3000 IG = 1, NG(7)
            TAUG(LAY,IG) = COLO3(LAY) *
     &          (FAC00(LAY) * ABSB(IND0,IG) +
     &           FAC10(LAY) * ABSB(IND0+1,IG) +
     &           FAC01(LAY) * ABSB(IND1,IG) + 
     &           FAC11(LAY) * ABSB(IND1+1,IG))
            FRACS(LAY,IG) = FRACREFB(IG)
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

*******************************************************************************

      SUBROUTINE TAUGB8

C     BAND 8:  1080-1180 cm-1 (low (i.e.>~300mb) - H2O; high - O3)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY),SELFFRAC(MXLAY),INDSELF(MXLAY)
      COMMON /K8/       KA(5,7,MG), KB(5,7:59,MG), SELFREF(10,MG)

      DIMENSION ABSA(35,MG),ABSB(265,MG)
      DIMENSION FRACREFA(MG),FRACREFB(MG)

C     From P = 1053.6 mb.
      DATA FRACREFA/
     &    0.15309700,0.15450300,0.14458799,0.13098200,
     &    0.11817900,0.09953490,0.08132080,0.06139960,
     &    0.04132010,0.00446788,0.00372533,0.00294053,
     &    0.00211371,0.00128122,0.00048050,0.00006759/
C     From P = 28.9 mb.
      DATA FRACREFB/
     &    0.14105400,0.14728899,0.14264800,0.13331699,
     &    0.12034100,0.10467000,0.08574980,0.06469390,
     &    0.04394640,0.00481284,0.00397375,0.00315006,
     &    0.00228636,0.00144606,0.00054604,0.00007697/

      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB

C     Compute the optical depth by interpolating in ln(pressure) and 
C     temperature.  
      DO 2500 LAY = 1, LAYSWTCH
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(8) + 1
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(8) + 1
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(8)
            TAUG(LAY,IG) = COLH2O(LAY) *
     &          (FAC00(LAY) * ABSA(IND0,IG) +
     &           FAC10(LAY) * ABSA(IND0+1,IG) +
     &           FAC01(LAY) * ABSA(IND1,IG) + 
     &           FAC11(LAY) * ABSA(IND1+1,IG) + 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG))))
            FRACS(LAY,IG) = FRACREFA(IG)
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYSWTCH+1, NLAYERS
         IND0 = ((JP(LAY)-7)*5+(JT(LAY)-1))*NSPB(8) + 1
         IND1 = ((JP(LAY)-6)*5+(JT1(LAY)-1))*NSPB(8) + 1
         DO 3000 IG = 1, NG(8)
            TAUG(LAY,IG) = COLO3(LAY) * 
     &          (FAC00(LAY) * ABSB(IND0,IG) +
     &           FAC10(LAY) * ABSB(IND0+1,IG) +
     &           FAC01(LAY) * ABSB(IND1,IG) + 
     &           FAC11(LAY) * ABSB(IND1+1,IG)) 
            FRACS(LAY,IG) = FRACREFB(IG)
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB9

C     BAND 9:  1180-1390 cm-1 (low - H2O,CH4; high - CH4)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

      DIMENSION ABSA(715,MG),ABSB(235,MG)
      DIMENSION FRACREFA(MG,9), FRACREFB(MG)

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PRECISE/  ONEMINUS
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K9/       KA(11,5,13,MG),KB(5,13:59,MG),SELFREF(10,MG)

      DATA FRACREFA/
C     From P = 1053.6 mb.
     &    0.16898900,0.15898301,0.13575301,0.12600900,
     &    0.11545800,0.09879170,0.08106830,0.06063440,
     &    0.03988780,0.00421760,0.00346635,0.00278779,
     &    0.00206225,0.00132324,0.00050033,0.00007038,
     &    0.18209399,0.15315101,0.13571000,0.12504999,
     &    0.11379100,0.09680810,0.08008570,0.05970280,
     &    0.03942860,0.00413383,0.00343186,0.00275558,
     &    0.00204657,0.00130219,0.00045454,0.00005664,
     &    0.18459500,0.15512000,0.13395500,0.12576801,
     &    0.11276800,0.09645190,0.07956650,0.05903340,
     &    0.03887050,0.00412226,0.00339453,0.00273518,
     &    0.00196922,0.00119411,0.00040263,0.00005664,
     &    0.18458800,0.15859900,0.13278100,0.12589300,
     &    0.11272700,0.09599660,0.07903030,0.05843600,
     &    0.03843400,0.00405181,0.00337980,0.00263818,
     &    0.00186869,0.00111807,0.00040263,0.00005664,
     &    0.18459301,0.16176100,0.13235000,0.12528200,
     &    0.11237100,0.09618840,0.07833760,0.05800770,
     &    0.03787610,0.00408253,0.00330363,0.00250445,
     &    0.00176725,0.00111753,0.00040263,0.00005664,
     &    0.18454400,0.16505300,0.13221300,0.12476600,
     &    0.11158300,0.09618120,0.07797340,0.05740380,
     &    0.03742820,0.00392691,0.00312208,0.00246306,
     &    0.00176735,0.00111721,0.00040263,0.00005664,
     &    0.18452001,0.16697501,0.13445500,0.12391300,
     &    0.11059100,0.09596890,0.07761050,0.05643200,
     &    0.03686520,0.00377086,0.00309351,0.00246297,
     &    0.00176765,0.00111700,0.00040263,0.00005664,
     &    0.18460999,0.16854499,0.13922299,0.12266400,
     &    0.10962200,0.09452030,0.07653800,0.05551340,
     &    0.03609660,0.00377043,0.00309367,0.00246304,
     &    0.00176749,0.00111689,0.00040263,0.00005664,
     &    0.18312500,0.16787501,0.14720701,0.12766500,
     &    0.10890900,0.08935530,0.07310870,0.05443140,
     &    0.03566380,0.00376446,0.00309521,0.00246510,
     &    0.00176139,0.00111543,0.00040263,0.00005664/
C     From P = 0.071 mb.
      DATA FRACREFB/
     &    0.20148601,0.15252700,0.13376500,0.12184600,
     &    0.10767800,0.09307410,0.07674570,0.05876940,
     &    0.04001480,0.00424612,0.00346896,0.00269954,
     &    0.00196864,0.00122562,0.00043628,0.00004892/

      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA, KB
      STRRAT1 = 21.6282

C     Compute the optical depth by interpolating in ln(pressure), 
C     temperature, and appropriate species.  Below LAYTROP, the water
C     vapor self-continuum is interpolated (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLCH4(LAY)
         SPECPARM = COLH2O(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         SPECMULT = 8.*(SPECPARM)
         JS = 1 + INT(SPECMULT)
         JFRAC = JS
	 FS = AMOD(SPECMULT,1.0)
         FFRAC = FS
         IF (JS .EQ. 8) THEN
            IF (FS. LE. 0.68) THEN
               FS = FS/0.68
            ELSEIF (FS .LE. 0.92) THEN
               JS = JS + 1
               FS = (FS-0.68)/0.24
            ELSE
               JS = JS + 2
               FS = (FS-0.92)/0.08
            ENDIF
         ELSEIF (JS .EQ.9) THEN
            JS = 10
            FS = 1.
            JFRAC = 8
            FFRAC = 1.
         ENDIF
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         FAC001 = (1. - FS) * FAC01(LAY)
         FAC011 = (1. - FS) * FAC11(LAY)
         FAC101 = FS * FAC01(LAY)
         FAC111 = FS * FAC11(LAY)
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(9) + JS
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(9) + JS
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(9)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSA(IND0,IG) +
     &           FAC100 * ABSA(IND0+1,IG) +
     &           FAC010 * ABSA(IND0+11,IG) +
     &           FAC110 * ABSA(IND0+12,IG) +
     &           FAC001 * ABSA(IND1,IG) + 
     &           FAC101 * ABSA(IND1+1,IG) +
     &           FAC011 * ABSA(IND1+11,IG) +
     &           FAC111 * ABSA(IND1+12,IG)) +
     &           COLH2O(LAY) * 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG)))
            FRACS(LAY,IG) = FRACREFA(IG,JFRAC) + FFRAC *
     &           (FRACREFA(IG,JFRAC+1) - FRACREFA(IG,JFRAC))
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(9) + 1
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(9) + 1
         DO 3000 IG = 1, NG(9)
            TAUG(LAY,IG) = COLCH4(LAY) *
     &          (FAC00(LAY) * ABSB(IND0,IG) +
     &           FAC10(LAY) * ABSB(IND0+1,IG) +
     &           FAC01(LAY) * ABSB(IND1,IG) + 
     &           FAC11(LAY) * ABSB(IND1+1,IG))
            FRACS(LAY,IG) = FRACREFB(IG)
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

*******************************************************************************


      SUBROUTINE TAUGB10

C     BAND 10:  1390-1480 cm-1 (low - H2O; high - H2O)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /K10/   KA(5,13,MG), KB(5,13:59,MG)

      DIMENSION ABSA(65,MG),ABSB(235,MG)
      DIMENSION FRACREFA(MG),FRACREFB(MG)

C     From P = 473 mb.
      DATA FRACREFA/
     &    0.16271301,0.15141940,0.14065412,0.12899506,
     &    0.11607002,0.10142808,0.08116794,0.06104711,
     &    0.04146209,0.00447386,0.00372902,0.00287258,
     &    0.00206028,0.00134634,0.00049232,0.00006927/
C     From P = 1.17 mb.
      DATA FRACREFB/
     &    0.16571465,0.15262246,0.14036226,0.12620729,
     &    0.11477834,0.09967982,0.08155201,0.06159503,
     &    0.04196607,0.00453940,0.00376881,0.00300437,
     &    0.00223034,0.00139432,0.00051516,0.00007095/

      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB

C     Compute the optical depth by interpolating in ln(pressure) and 
C     temperature.  
      DO 2500 LAY = 1, LAYTROP
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(10) + 1
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(10) + 1
         DO 2000 IG = 1, NG(10)
            TAUG(LAY,IG) = COLH2O(LAY) *
     &          (FAC00(LAY) * ABSA(IND0,IG) +
     &           FAC10(LAY) * ABSA(IND0+1,IG) +
     &           FAC01(LAY) * ABSA(IND1,IG) + 
     &           FAC11(LAY) * ABSA(IND1+1,IG)) 
            FRACS(LAY,IG) = FRACREFA(IG)
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(10) + 1
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(10) + 1
         DO 3000 IG = 1, NG(10)
            TAUG(LAY,IG) = COLH2O(LAY) * 
     &          (FAC00(LAY) * ABSB(IND0,IG) +
     &           FAC10(LAY) * ABSB(IND0+1,IG) +
     &           FAC01(LAY) * ABSB(IND1,IG) + 
     &           FAC11(LAY) * ABSB(IND1+1,IG)) 
            FRACS(LAY,IG) = FRACREFB(IG)
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

*******************************************************************************

      SUBROUTINE TAUGB11

C     BAND 11:  1480-1800 cm-1 (low - H2O; high - H2O)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K11/      KA(5,13,MG), KB(5,13:59,MG) , SELFREF(10,MG)

      DIMENSION ABSA(65,MG),ABSB(235,MG)
      DIMENSION FRACREFA(MG),FRACREFB(MG)

C     From P = 473 mb.
      DATA FRACREFA/
     &    0.14152819,0.13811260,0.14312185,0.13705885,
     &    0.11944738,0.10570189,0.08866373,0.06565409,
     &    0.04428961,0.00481540,0.00387058,0.00329187,
     &    0.00238294,0.00150971,0.00049287,0.00005980/
C     From P = 1.17 mb.
      DATA FRACREFB/
     &    0.10874039,0.15164889,0.15149839,0.14515044,
     &    0.12486220,0.10725017,0.08715712,0.06463144,
     &    0.04332319,0.00441193,0.00393819,0.00305960,
     &    0.00224221,0.00145100,0.00055586,0.00007934/

      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB

C     Compute the optical depth by interpolating in ln(pressure) and 
C     temperature.  Below LAYTROP, the water vapor self-continuum 
C     is interpolated (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(11) + 1
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(11) + 1
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(11)
            TAUG(LAY,IG) = COLH2O(LAY) *
     &          (FAC00(LAY) * ABSA(IND0,IG) +
     &           FAC10(LAY) * ABSA(IND0+1,IG) +
     &           FAC01(LAY) * ABSA(IND1,IG) + 
     &           FAC11(LAY) * ABSA(IND1+1,IG) +
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG))))
            FRACS(LAY,IG) = FRACREFA(IG)
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(11) + 1
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(11) + 1
         DO 3000 IG = 1, NG(11)
            TAUG(LAY,IG) = COLH2O(LAY) * 
     &          (FAC00(LAY) * ABSB(IND0,IG) +
     &           FAC10(LAY) * ABSB(IND0+1,IG) +
     &           FAC01(LAY) * ABSB(IND1,IG) + 
     &           FAC11(LAY) * ABSB(IND1+1,IG)) 
            FRACS(LAY,IG) = FRACREFB(IG)
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB12

C     BAND 12:  1800-2080 cm-1 (low - H2O,CO2; high - nothing)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PRECISE/  ONEMINUS
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K12/      KA(9,5,13,MG),SELFREF(10,MG)

      DIMENSION ABSA(585,MG)
      DIMENSION FRACREFA(MG,9)

      DATA FRACREFA/
C     From P = 706.3 mb.
     &    0.21245100,0.15164700,0.14486700,0.13075501,
     &    0.11629600,0.09266050,0.06579930,0.04524000,
     &    0.03072870,0.00284297,0.00234660,0.00185208,
     &    0.00133978,0.00082214,0.00031016,0.00004363,
     &    0.14703900,0.16937999,0.15605700,0.14159000,
     &    0.12088500,0.10058500,0.06809110,0.05131470,
     &    0.03487040,0.00327281,0.00250183,0.00190024,
     &    0.00133978,0.00082214,0.00031016,0.00004363,
     &    0.13689300,0.16610400,0.15723500,0.14299500,
     &    0.12399400,0.09907820,0.07169690,0.05367370,
     &    0.03671630,0.00378148,0.00290510,0.00221076,
     &    0.00142810,0.00093527,0.00031016,0.00004363,
     &    0.13054299,0.16273800,0.15874299,0.14279599,
     &    0.12674300,0.09664900,0.07462200,0.05620080,
     &    0.03789090,0.00411690,0.00322920,0.00245036,
     &    0.00178303,0.00098595,0.00040802,0.00010150,
     &    0.12828299,0.15824600,0.15688400,0.14449100,
     &    0.12787800,0.09517830,0.07679350,0.05890820,
     &    0.03883570,0.00442304,0.00346796,0.00255333,
     &    0.00212519,0.00116168,0.00067065,0.00010150,
     &    0.12649800,0.15195100,0.15646499,0.14569700,
     &    0.12669300,0.09653520,0.07887920,0.06106920,
     &    0.04043910,0.00430390,0.00364453,0.00314360,
     &    0.00203206,0.00187787,0.00067075,0.00010150,
     &    0.12500300,0.14460599,0.15672199,0.14724600,
     &    0.11978900,0.10190200,0.08196710,0.06315770,
     &    0.04240100,0.00433645,0.00404097,0.00329466,
     &    0.00288491,0.00187803,0.00067093,0.00010150,
     &    0.12317200,0.14118700,0.15242000,0.13794300,
     &    0.12119200,0.10655400,0.08808350,0.06521370,
     &    0.04505680,0.00485949,0.00477105,0.00401468,
     &    0.00288491,0.00187786,0.00067110,0.00010150,
     &    0.10193600,0.11693000,0.13236099,0.14053200,
     &    0.13749801,0.12193100,0.10221000,0.07448910,
     &    0.05205320,0.00572312,0.00476882,0.00403380,
     &    0.00288871,0.00187396,0.00067218,0.00010150/

      EQUIVALENCE (KA,ABSA)

      REAL KA
      STRRAT1 = 0.009736757

C     Compute the optical depth by interpolating in ln(pressure), 
C     temperature, and appropriate species.  Below LAYTROP, the water
C     vapor self-continuum is interpolated (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLCO2(LAY)
         SPECPARM = COLH2O(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         SPECMULT = 8.*(SPECPARM)
         JS = 1 + INT(SPECMULT)
	 FS = AMOD(SPECMULT,1.0)
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         FAC001 = (1. - FS) * FAC01(LAY)
         FAC011 = (1. - FS) * FAC11(LAY)
         FAC101 = FS * FAC01(LAY)
         FAC111 = FS * FAC11(LAY)
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(12) + JS
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(12) + JS
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(12)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSA(IND0,IG) +
     &           FAC100 * ABSA(IND0+1,IG) +
     &           FAC010 * ABSA(IND0+9,IG) +
     &           FAC110 * ABSA(IND0+10,IG) +
     &           FAC001 * ABSA(IND1,IG) + 
     &           FAC101 * ABSA(IND1+1,IG) +
     &           FAC011 * ABSA(IND1+9,IG) +
     &           FAC111 * ABSA(IND1+10,IG)) +
     &           COLH2O(LAY) * 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG)))
            FRACS(LAY,IG) = FRACREFA(IG,JS) + FS *
     &           (FRACREFA(IG,JS+1) - FRACREFA(IG,JS))
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         DO 3000 IG = 1, NG(12)
            TAUG(LAY,IG) = 0.0
            FRACS(LAY,IG) = 0.0
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB13

C     BAND 13:  2080-2250 cm-1 (low - H2O,N2O; high - nothing)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PRECISE/  ONEMINUS
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K13/      KA(9,5,13,MG),SELFREF(10,MG)

      DIMENSION ABSA(585,MG)
      DIMENSION FRACREFA(MG,9)

      DATA FRACREFA/
C     From P = 706.3 mb.
     &    0.17683899,0.17319500,0.15712699,0.13604601,
     &    0.10776200,0.08750010,0.06808820,0.04905150,
     &    0.03280360,0.00350836,0.00281864,0.00219862,
     &    0.00160943,0.00101885,0.00038147,0.00005348,
     &    0.17535400,0.16999300,0.15610200,0.13589200,
     &    0.10842100,0.08988550,0.06943920,0.04974900,
     &    0.03323400,0.00352752,0.00289402,0.00231003,
     &    0.00174659,0.00101884,0.00038147,0.00005348,
     &    0.17409500,0.16846400,0.15641899,0.13503000,
     &    0.10838600,0.08985800,0.07092720,0.05075710,
     &    0.03364180,0.00354241,0.00303507,0.00243391,
     &    0.00177502,0.00114638,0.00043585,0.00005348,
     &    0.17248300,0.16778600,0.15543500,0.13496999,
     &    0.10826300,0.09028740,0.07156720,0.05187120,
     &    0.03424890,0.00363933,0.00324715,0.00255030,
     &    0.00187380,0.00116978,0.00051229,0.00009768,
     &    0.17061099,0.16715799,0.15405200,0.13471501,
     &    0.10896400,0.09069460,0.07229760,0.05218280,
     &    0.03555340,0.00379576,0.00330240,0.00274693,
     &    0.00201587,0.00119598,0.00061885,0.00009768,
     &    0.16789700,0.16629100,0.15270300,0.13360199,
     &    0.11047200,0.09151080,0.07325000,0.05261450,
     &    0.03657990,0.00450092,0.00349537,0.00283321,
     &    0.00208396,0.00140354,0.00066587,0.00009768,
     &    0.16412200,0.16387400,0.15211500,0.13062200,
     &    0.11325100,0.09348130,0.07381380,0.05434740,
     &    0.03803160,0.00481346,0.00393592,0.00296633,
     &    0.00222532,0.00163762,0.00066648,0.00009768,
     &    0.15513401,0.15768200,0.14850400,0.13330200,
     &    0.11446500,0.09868230,0.07642050,0.05624170,
     &    0.04197810,0.00502288,0.00429452,0.00315347,
     &    0.00263559,0.00171772,0.00066860,0.00009768,
     &    0.15732600,0.15223300,0.14271900,0.13563600,
     &    0.11859600,0.10274200,0.07934560,0.05763410,
     &    0.03921740,0.00437741,0.00337921,0.00280212,
     &    0.00200156,0.00124812,0.00064664,0.00009768/

      EQUIVALENCE (KA,ABSA)

      REAL KA
      STRRAT1 = 16658.87

C     Compute the optical depth by interpolating in ln(pressure), 
C     temperature, and appropriate species.  Below LAYTROP, the water
C     vapor self-continuum is interpolated (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLN2O(LAY)
         SPECPARM = COLH2O(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         SPECMULT = 8.*(SPECPARM)
         JS = 1 + INT(SPECMULT)
	 FS = AMOD(SPECMULT,1.0)
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         FAC001 = (1. - FS) * FAC01(LAY)
         FAC011 = (1. - FS) * FAC11(LAY)
         FAC101 = FS * FAC01(LAY)
         FAC111 = FS * FAC11(LAY)
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(13) + JS
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(13) + JS
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(13)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSA(IND0,IG) +
     &           FAC100 * ABSA(IND0+1,IG) +
     &           FAC010 * ABSA(IND0+9,IG) +
     &           FAC110 * ABSA(IND0+10,IG) +
     &           FAC001 * ABSA(IND1,IG) + 
     &           FAC101 * ABSA(IND1+1,IG) +
     &           FAC011 * ABSA(IND1+9,IG) +
     &           FAC111 * ABSA(IND1+10,IG)) +
     &           COLH2O(LAY) * 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG)))
            FRACS(LAY,IG) = FRACREFA(IG,JS) + FS *
     &           (FRACREFA(IG,JS+1) - FRACREFA(IG,JS))
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         DO 3000 IG = 1, NG(13)
            TAUG(LAY,IG) = 0.0
            FRACS(LAY,IG) = 0.0
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

*******************************************************************************

      SUBROUTINE TAUGB14

C     BAND 14:  2250-2380 cm-1 (low - CO2; high - CO2)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K14/      KA(5,13,MG), KB(5,13:59,MG) , SELFREF(10,MG)

      DIMENSION ABSA(65,MG),ABSB(235,MG)
      DIMENSION FRACREFA(MG),FRACREFB(MG)

C     From P = 1053.6 mb.
      DATA FRACREFA/
     &    0.18446200,0.16795200,0.14949700,0.12036000,
     &    0.10440100,0.09024280,0.07435880,0.05629380,
     &    0.03825420,0.00417276,0.00345278,0.00272949,
     &    0.00200378,0.00127404,0.00050721,0.00004141/
C     From P = 0.64 mb.
      DATA FRACREFB/
     &    0.19128500,0.16495700,0.14146100,0.11904500,
     &    0.10350200,0.09151190,0.07604270,0.05806020,
     &    0.03979950,0.00423959,0.00357439,0.00287559,
     &    0.00198860,0.00116529,0.00043616,0.00005987/

      EQUIVALENCE (KA,ABSA),(KB,ABSB)

      REAL KA,KB

C     Compute the optical depth by interpolating in ln(pressure) and 
C     temperature.  Below LAYTROP, the water vapor self-continuum 
C     is interpolated (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(14) + 1
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(14) + 1
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(14)
            TAUG(LAY,IG) = COLCO2(LAY) *
     &          (FAC00(LAY) * ABSA(IND0,IG) +
     &           FAC10(LAY) * ABSA(IND0+1,IG) +
     &           FAC01(LAY) * ABSA(IND1,IG) + 
     &           FAC11(LAY) * ABSA(IND1+1,IG) +
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG))))
            FRACS(LAY,IG) = FRACREFA(IG)
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         IND0 = ((JP(LAY)-13)*5+(JT(LAY)-1))*NSPB(14) + 1
         IND1 = ((JP(LAY)-12)*5+(JT1(LAY)-1))*NSPB(14) + 1
         DO 3000 IG = 1, NG(14)
            TAUG(LAY,IG) = COLCO2(LAY) * 
     &          (FAC00(LAY) * ABSB(IND0,IG) +
     &           FAC10(LAY) * ABSB(IND0+1,IG) +
     &           FAC01(LAY) * ABSB(IND1,IG) + 
     &           FAC11(LAY) * ABSB(IND1+1,IG)) 
            FRACS(LAY,IG) = FRACREFB(IG)
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB15

C     BAND 15:  2380-2600 cm-1 (low - N2O,CO2; high - nothing)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PRECISE/  ONEMINUS
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K15/      KA(9,5,13,MG),SELFREF(10,MG)

      DIMENSION ABSA(585,MG)
      DIMENSION FRACREFA(MG,9)

      DATA FRACREFA/
C     From P = 1053.6 mb.
     &    0.11287100,0.12070200,0.12729000,0.12858100,
     &    0.12743001,0.11961800,0.10290400,0.07888980,
     &    0.05900120,0.00667979,0.00552926,0.00436993,
     &    0.00320611,0.00204765,0.00077371,0.00010894,
     &    0.13918801,0.16353001,0.16155800,0.14090499,
     &    0.11322300,0.08757720,0.07225720,0.05173390,
     &    0.04731360,0.00667979,0.00552926,0.00436993,
     &    0.00320611,0.00204765,0.00077371,0.00010894,
     &    0.14687300,0.17853101,0.15664500,0.13351700,
     &    0.10791200,0.08684320,0.07158090,0.05198410,
     &    0.04340110,0.00667979,0.00552926,0.00436993,
     &    0.00320611,0.00204765,0.00077371,0.00010894,
     &    0.15760700,0.17759100,0.15158001,0.13193300,
     &    0.10742800,0.08693760,0.07159490,0.05196250,
     &    0.04065270,0.00667979,0.00552926,0.00436993,
     &    0.00320611,0.00204765,0.00077371,0.00010894,
     &    0.16646700,0.17299300,0.15018500,0.13138700,
     &    0.10735900,0.08713110,0.07130330,0.05279420,
     &    0.03766730,0.00667979,0.00552926,0.00436993,
     &    0.00320611,0.00204765,0.00077371,0.00010894,
     &    0.17546000,0.16666500,0.14969499,0.13105400,
     &    0.10782500,0.08718610,0.07156770,0.05308320,
     &    0.03753960,0.00432465,0.00509623,0.00436993,
     &    0.00320611,0.00204765,0.00077371,0.00010894,
     &    0.18378501,0.16064601,0.14940400,0.13146400,
     &    0.10810300,0.08775740,0.07115360,0.05400040,
     &    0.03689970,0.00388333,0.00323610,0.00353414,
     &    0.00320611,0.00204765,0.00077371,0.00010894,
     &    0.18966800,0.15744300,0.14993000,0.13152599,
     &    0.10899200,0.08858690,0.07142920,0.05399600,
     &    0.03433460,0.00374886,0.00302066,0.00240653,
     &    0.00199205,0.00204765,0.00077371,0.00010894,
     &    0.11887100,0.12479600,0.12569501,0.12839900,
     &    0.12473500,0.12012800,0.11086700,0.08493590,
     &    0.05063770,0.00328723,0.00266849,0.00210232,
     &    0.00152114,0.00095635,0.00035374,0.00004980/

      EQUIVALENCE (KA,ABSA)

      REAL KA
      STRRAT1 = 0.2883201

C     Compute the optical depth by interpolating in ln(pressure), 
C     temperature, and appropriate species.  Below LAYTROP, the water
C     vapor self-continuum is interpolated (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         SPECCOMB = COLN2O(LAY) + STRRAT1*COLCO2(LAY)
         SPECPARM = COLN2O(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         SPECMULT = 8.*(SPECPARM)
         JS = 1 + INT(SPECMULT)
	 FS = AMOD(SPECMULT,1.0)
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         FAC001 = (1. - FS) * FAC01(LAY)
         FAC011 = (1. - FS) * FAC11(LAY)
         FAC101 = FS * FAC01(LAY)
         FAC111 = FS * FAC11(LAY)
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(15) + JS
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(15) + JS
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(15)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSA(IND0,IG) +
     &           FAC100 * ABSA(IND0+1,IG) +
     &           FAC010 * ABSA(IND0+9,IG) +
     &           FAC110 * ABSA(IND0+10,IG) +
     &           FAC001 * ABSA(IND1,IG) + 
     &           FAC101 * ABSA(IND1+1,IG) +
     &           FAC011 * ABSA(IND1+9,IG) +
     &           FAC111 * ABSA(IND1+10,IG)) +
     &           COLH2O(LAY) * 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG)))
            FRACS(LAY,IG) = FRACREFA(IG,JS) + FS *
     &           (FRACREFA(IG,JS+1) - FRACREFA(IG,JS))
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         DO 3000 IG = 1, NG(15)
            TAUG(LAY,IG) = 0.0
            FRACS(LAY,IG) = 0.0
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END

C----------------------------------------------------------------------------

      SUBROUTINE TAUGB16

C     BAND 16:  2600-3000 cm-1 (low - H2O,CH4; high - nothing)

      PARAMETER (MG=16, MXLAY=203, NBANDS=16)

C  Output

      COMMON /TAUGCOM/  TAUG(MXLAY,MG)
      COMMON /PLANKG/   FRACS(MXLAY,MG)                                       

C  Input

      COMMON /FEATURES/ NG(NBANDS),NSPA(NBANDS),NSPB(NBANDS)
      COMMON /PRECISE/  ONEMINUS
      COMMON /PROFILE/  NLAYERS,PAVEL(MXLAY),TAVEL(MXLAY),
     &                  PZ(0:MXLAY),TZ(0:MXLAY),TBOUND
      COMMON /PROFDATA/ LAYTROP,LAYSWTCH,COLH2O(MXLAY),COLCO2(MXLAY),
     &                  COLO3(MXLAY),COLN2O(MXLAY),COLCH4(MXLAY)
      COMMON /INTFAC/   FAC00(MXLAY),FAC01(MXLAY),                            
     &                  FAC10(MXLAY),FAC11(MXLAY)                             
      COMMON /INTIND/   JP(MXLAY),JT(MXLAY),JT1(MXLAY)
      COMMON /SELF/     SELFFAC(MXLAY), SELFFRAC(MXLAY), INDSELF(MXLAY)
      COMMON /K16/      KA(9,5,13,MG),SELFREF(10,MG)

      DIMENSION ABSA(585,MG)
      DIMENSION FRACREFA(MG,9)

      DATA FRACREFA/
C     From P = 862.6 mb.
     &    0.17356300,0.18880001,0.17704099,0.13661300,
     &    0.10691600,0.08222480,0.05939860,0.04230810,
     &    0.02526330,0.00244532,0.00193541,0.00150415,
     &    0.00103528,0.00067068,0.00024951,0.00003348,
     &    0.17779499,0.19837400,0.16557600,0.13470000,
     &    0.11013600,0.08342720,0.05987030,0.03938700,
     &    0.02293650,0.00238849,0.00192400,0.00149921,
     &    0.00103539,0.00067150,0.00024822,0.00003348,
     &    0.18535601,0.19407199,0.16053200,0.13300700,
     &    0.10779000,0.08408500,0.06480450,0.04070160,
     &    0.02203590,0.00227779,0.00189074,0.00146888,
     &    0.00103147,0.00066770,0.00024751,0.00003348,
     &    0.19139200,0.18917400,0.15748601,0.13240699,
     &    0.10557300,0.08383260,0.06724060,0.04364450,
     &    0.02175820,0.00225436,0.00184421,0.00143153,
     &    0.00103027,0.00066066,0.00024222,0.00003148,
     &    0.19547801,0.18539500,0.15442000,0.13114899,
     &    0.10515600,0.08350350,0.06909780,0.04671630,
     &    0.02168820,0.00224400,0.00182009,0.00139098,
     &    0.00102582,0.00065367,0.00023202,0.00003148,
     &    0.19757500,0.18266800,0.15208900,0.12897800,
     &    0.10637200,0.08391220,0.06989830,0.04964120,
     &    0.02155800,0.00224310,0.00177358,0.00138184,
     &    0.00101538,0.00063370,0.00023227,0.00003148,
     &    0.20145500,0.17692900,0.14940600,0.12690400,
     &    0.10828800,0.08553720,0.07004940,0.05153430,
     &    0.02268740,0.00216943,0.00178603,0.00137754,
     &    0.00098344,0.00063165,0.00023218,0.00003148,
     &    0.20383500,0.17047501,0.14570600,0.12679300,
     &    0.11043100,0.08719150,0.07045440,0.05345420,
     &    0.02448340,0.00215839,0.00175893,0.00138296,
     &    0.00098318,0.00063188,0.00023199,0.00003148,
     &    0.18680701,0.15961801,0.15092900,0.13049100,
     &    0.11418400,0.09380540,0.07093450,0.05664280,
     &    0.02938410,0.00217751,0.00176766,0.00138275,
     &    0.00098377,0.00063181,0.00023193,0.00003148/

      EQUIVALENCE (KA,ABSA)

      REAL KA
      STRRAT1 = 830.411

C     Compute the optical depth by interpolating in ln(pressure), 
C     temperature, and appropriate species.  Below LAYTROP, the water
C     vapor self-continuum is interpolated (in temperature) separately.  
      DO 2500 LAY = 1, LAYTROP
         SPECCOMB = COLH2O(LAY) + STRRAT1*COLCH4(LAY)
         SPECPARM = COLH2O(LAY)/SPECCOMB 
         IF (SPECPARM .GE. ONEMINUS) SPECPARM = ONEMINUS
         SPECMULT = 8.*(SPECPARM)
         JS = 1 + INT(SPECMULT)
	 FS = AMOD(SPECMULT,1.0)
         FAC000 = (1. - FS) * FAC00(LAY)
         FAC010 = (1. - FS) * FAC10(LAY)
         FAC100 = FS * FAC00(LAY)
         FAC110 = FS * FAC10(LAY)
         FAC001 = (1. - FS) * FAC01(LAY)
         FAC011 = (1. - FS) * FAC11(LAY)
         FAC101 = FS * FAC01(LAY)
         FAC111 = FS * FAC11(LAY)
         IND0 = ((JP(LAY)-1)*5+(JT(LAY)-1))*NSPA(16) + JS
         IND1 = (JP(LAY)*5+(JT1(LAY)-1))*NSPA(16) + JS
         INDS = INDSELF(LAY)
         DO 2000 IG = 1, NG(16)
            TAUG(LAY,IG) = SPECCOMB * 
     &          (FAC000 * ABSA(IND0,IG) +
     &           FAC100 * ABSA(IND0+1,IG) +
     &           FAC010 * ABSA(IND0+9,IG) +
     &           FAC110 * ABSA(IND0+10,IG) +
     &           FAC001 * ABSA(IND1,IG) + 
     &           FAC101 * ABSA(IND1+1,IG) +
     &           FAC011 * ABSA(IND1+9,IG) +
     &           FAC111 * ABSA(IND1+10,IG)) +
     &           COLH2O(LAY) * 
     &           SELFFAC(LAY) * (SELFREF(INDS,IG) + 
     &           SELFFRAC(LAY) *
     &           (SELFREF(INDS+1,IG) - SELFREF(INDS,IG)))
            FRACS(LAY,IG) = FRACREFA(IG,JS) + FS *
     &           (FRACREFA(IG,JS+1) - FRACREFA(IG,JS))
 2000    CONTINUE
 2500 CONTINUE

      DO 3500 LAY = LAYTROP+1, NLAYERS
         DO 3000 IG = 1, NG(16)
            TAUG(LAY,IG) = 0.0
            FRACS(LAY,IG) = 0.0
 3000    CONTINUE
 3500 CONTINUE

      RETURN
      END
